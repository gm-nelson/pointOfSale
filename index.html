<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snack Orders - Sistema de Comandas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #004E89;
            --light: #F8F9FA;
            --dark: #212529;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary);
            font-weight: bold;
        }

        .business-info h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .business-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .config-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        .config-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background-color: rgba(255, 107, 53, 0.1);
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--secondary);
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--secondary);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-process {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .product-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .product-img {
            height: 150px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: #adb5bd;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-price {
            color: var(--primary);
            font-weight: bold;
            font-size: 18px;
        }

        .order-summary {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }

        .order-summary h3 {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            border-bottom: none;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-btn:hover {
            background-color: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .data-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .step-container {
            display: flex;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .step {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .step.active .step-number {
            background-color: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--success);
            color: white;
        }

        .step-text {
            font-weight: 600;
            color: #6c757d;
        }

        .step.active .step-text {
            color: var(--primary);
        }

        .step.completed .step-text {
            color: var(--success);
        }

        .step-line {
            flex: 1;
            height: 3px;
            background-color: #e9ecef;
            margin: 0 10px;
        }

        .step.completed .step-line {
            background-color: var(--success);
        }

        .customer-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .customer-card {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .customer-card:hover {
            border-color: var(--primary);
            background-color: rgba(255, 107, 53, 0.05);
        }

        .customer-card.selected {
            border-color: var(--primary);
            background-color: rgba(255, 107, 53, 0.1);
        }

        .customer-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .customer-phone {
            color: #6c757d;
            font-size: 14px;
        }

        .order-products {
            margin-top: 20px;
        }

        .product-order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .product-order-info {
            flex: 1;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            background-color: var(--dark);
            color: white;
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--primary);
            margin: 0 auto 20px;
            overflow: hidden;
        }

        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-screen h1 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .welcome-screen p {
            margin-bottom: 30px;
            color: #6c757d;
        }

        .order-detail-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .step-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .step-line {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo" id="logo">S</div>
                <div class="business-info">
                    <h1 id="business-name">Snack Orders</h1>
                    <p id="business-contact">WhatsApp: +52 123 456 7890</p>
                </div>
            </div>
            <button class="config-btn" id="configBtn">
                <i class="fas fa-cog"></i> Configuración
            </button>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="orders">Comandas</div>
            <div class="tab" data-tab="products">Productos</div>
            <div class="tab" data-tab="customers">Clientes</div>
        </div>

        <!-- Contenido de la pestaña Comandas -->
        <div class="tab-content active" id="orders-content">
            <div class="section-title">
                <span>Gestión de Comandas</span>
                <button class="btn btn-primary" id="newOrderBtn">
                    <i class="fas fa-plus"></i> Nueva Orden
                </button>
            </div>
            
            <div class="table-container">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Las órdenes se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyOrders">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No hay comandas registradas</h3>
                    <p>Crea tu primera comanda haciendo clic en "Nueva Orden"</p>
                </div>
            </div>
        </div>

        <!-- Contenido de la pestaña Productos -->
        <div class="tab-content" id="products-content">
            <div class="section-title">
                <span>Catálogo de Productos</span>
                <button class="btn btn-primary" id="newProductBtn">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </button>
            </div>
            
            <div class="product-grid" id="productsGrid">
                <!-- Los productos se cargarán aquí dinámicamente -->
            </div>
            <div class="empty-state" id="emptyProducts">
                <i class="fas fa-hamburger"></i>
                <h3>No hay productos registrados</h3>
                <p>Agrega tu primer producto haciendo clic en "Nuevo Producto"</p>
            </div>
        </div>

        <!-- Contenido de la pestaña Clientes -->
        <div class="tab-content" id="customers-content">
            <div class="section-title">
                <span>Base de Clientes</span>
                <button class="btn btn-primary" id="newCustomerBtn">
                    <i class="fas fa-plus"></i> Nuevo Cliente
                </button>
            </div>
            
            <div class="table-container">
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Órdenes</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        <!-- Los clientes se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyCustomers">
                    <i class="fas fa-users"></i>
                    <h3>No hay clientes registrados</h3>
                    <p>Agrega tu primer cliente haciendo clic en "Nuevo Cliente"</p>
                </div>
            </div>
        </div>

        <!-- Modal para crear/editar producto -->
        <div class="modal" id="productModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="productModalTitle">Nuevo Producto</h2>
                    <button class="btn btn-secondary btn-sm" id="closeProductModal">X</button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="form-group">
                            <label for="productName">Nombre del producto *</label>
                            <input type="text" id="productName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Precio unitario *</label>
                            <input type="number" id="productPrice" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productImage">URL de la imagen (opcional)</label>
                            <input type="text" id="productImage" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                            <small>Si no se proporciona, se usará una imagen por defecto</small>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para crear/editar cliente -->
        <div class="modal" id="customerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="customerModalTitle">Nuevo Cliente</h2>
                    <button class="btn btn-secondary btn-sm" id="closeCustomerModal">X</button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="form-group">
                            <label for="customerName">Nombre completo *</label>
                            <input type="text" id="customerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Teléfono (opcional)</label>
                            <input type="tel" id="customerPhone" class="form-control" placeholder="+52 123 456 7890">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para crear nueva orden -->
        <div class="modal" id="orderModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="orderModalTitle">Nueva Orden</h2>
                    <button class="btn btn-secondary btn-sm" id="closeOrderModal">X</button>
                </div>
                <div class="modal-body">
                    <div class="step-container">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-text">Cliente</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-text">Productos</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <div class="step-text">Confirmar</div>
                        </div>
                    </div>

                    <!-- Paso 1: Selección de cliente -->
                    <div id="orderStep1" class="order-step">
                        <h3>Seleccionar cliente</h3>
                        <p>Elige un cliente existente o crea uno nuevo</p>
                        
                        <div class="customer-selector" id="customerSelector">
                            <!-- Los clientes se cargarán aquí dinámicamente -->
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" id="selectCustomerBtn" disabled>
                                <i class="fas fa-user"></i> Usar este cliente
                            </button>
                            <button class="btn btn-secondary" id="newCustomerInOrderBtn">
                                <i class="fas fa-plus"></i> Crear nuevo cliente
                            </button>
                        </div>
                    </div>

                    <!-- Paso 2: Selección de productos -->
                    <div id="orderStep2" class="order-step" style="display: none;">
                        <h3>Seleccionar productos</h3>
                        <p>Elige los productos y cantidades para la orden</p>
                        
                        <div class="product-grid" id="orderProductsGrid">
                            <!-- Los productos para la orden se cargarán aquí dinámicamente -->
                        </div>
                        
                        <div class="order-products" id="orderSelectedProducts">
                            <!-- Los productos seleccionados se mostrarán aquí -->
                        </div>
                        
                        <div class="order-summary" id="orderSummary">
                            <h3>Resumen de la orden</h3>
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>IVA (16%):</span>
                                <span id="iva">$0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">$0.00</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button class="btn btn-secondary" id="backToStep1Btn">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button class="btn btn-primary" id="goToStep3Btn">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Paso 3: Confirmación -->
                    <div id="orderStep3" class="order-step" style="display: none;">
                        <h3>Confirmar orden</h3>
                        <p>Revisa los detalles de la orden antes de guardar</p>
                        
                        <div class="order-detail-card">
                            <h4>Cliente: <span id="confirmCustomerName">-</span></h4>
                            <p>Teléfono: <span id="confirmCustomerPhone">-</span></p>
                            
                            <h4 style="margin-top: 20px;">Productos:</h4>
                            <div id="confirmProductsList">
                                <!-- Los productos confirmados se mostrarán aquí -->
                            </div>
                            
                            <div class="order-summary" style="margin-top: 20px;">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span id="confirmSubtotal">$0.00</span>
                                </div>
                                <div class="summary-row">
                                    <span>IVA (16%):</span>
                                    <span id="confirmIva">$0.00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span id="confirmTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button class="btn btn-secondary" id="backToStep2Btn">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button class="btn btn-success" id="saveOrderBtn">
                                <i class="fas fa-check"></i> Guardar Orden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de configuración -->
        <div class="modal" id="configModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Configuración del Sistema</h2>
                    <button class="btn btn-secondary btn-sm" id="closeConfigModal">X</button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <div class="form-group">
                            <label>Logo del negocio</label>
                            <div class="logo-preview" id="logoPreview">
                                <span>S</span>
                            </div>
                            <input type="text" id="configLogo" class="form-control" placeholder="URL del logo (opcional)">
                        </div>
                        
                        <div class="form-group">
                            <label for="configBusinessName">Nombre del negocio *</label>
                            <input type="text" id="configBusinessName" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="configWhatsApp">Número de WhatsApp *</label>
                            <input type="text" id="configWhatsApp" class="form-control" required placeholder="+52 123 456 7890">
                        </div>
                        
                        <div class="form-group">
                            <label for="configAddress">Dirección (opcional)</label>
                            <input type="text" id="configAddress" class="form-control" placeholder="Calle y número, Ciudad, Estado">
                        </div>
                        
                        <div class="form-group">
                            <label for="configRFC">RFC (opcional)</label>
                            <input type="text" id="configRFC" class="form-control" placeholder="RFC para facturación">
                        </div>
                        
                        <hr style="margin: 30px 0;">
                        
                        <h3>Gestión de datos</h3>
                        <p>Exporta o importa todos los datos del sistema</p>
                        
                        <div class="data-actions">
                            <button type="button" class="btn btn-secondary" id="exportDataBtn">
                                <i class="fas fa-download"></i> Exportar Datos
                            </button>
                            <button type="button" class="btn btn-secondary" id="importDataBtn">
                                <i class="fas fa-upload"></i> Importar Datos
                            </button>
                            <button type="button" class="btn btn-danger" id="clearDataBtn">
                                <i class="fas fa-trash"></i> Borrar Todo
                            </button>
                        </div>
                        
                        <input type="file" id="importFileInput" style="display: none;" accept=".json">
                        
                        <div class="form-group" style="margin-top: 30px;">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de detalles de orden -->
        <div class="modal" id="orderDetailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Detalles de la Orden #<span id="detailOrderId"></span></h2>
                    <button class="btn btn-secondary btn-sm" id="closeOrderDetailModal">X</button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailContent">
                        <!-- Los detalles de la orden se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Pantalla de bienvenida (solo para primer uso) -->
        <div class="modal active" id="welcomeModal">
            <div class="modal-content">
                <div class="welcome-screen">
                    <div class="logo-preview">
                        <span>S</span>
                    </div>
                    <h1>¡Bienvenido a Snack Orders!</h1>
                    <p>Configura tu sistema de comandas para comenzar a gestionar pedidos de manera eficiente.</p>
                    <p>Primero, necesitamos algunos datos básicos de tu negocio.</p>
                    
                    <form id="welcomeForm" style="text-align: left; margin-top: 30px;">
                        <div class="form-group">
                            <label for="welcomeBusinessName">Nombre de tu negocio *</label>
                            <input type="text" id="welcomeBusinessName" class="form-control" required placeholder="Ej: Snacks Deliciosos">
                        </div>
                        
                        <div class="form-group">
                            <label for="welcomeWhatsApp">Número de WhatsApp *</label>
                            <input type="text" id="welcomeWhatsApp" class="form-control" required placeholder="+52 123 456 7890">
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-check"></i> Comenzar a usar el sistema
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notificación -->
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notificationText">Operación realizada con éxito</span>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        let selectedCustomer = null;
        let selectedProducts = {};
        let editingProductId = null;
        let editingCustomerId = null;
        let editingOrderId = null;

        // Elementos del DOM
        const elements = {
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Botones principales
            newOrderBtn: document.getElementById('newOrderBtn'),
            newProductBtn: document.getElementById('newProductBtn'),
            newCustomerBtn: document.getElementById('newCustomerBtn'),
            configBtn: document.getElementById('configBtn'),
            
            // Modales
            productModal: document.getElementById('productModal'),
            customerModal: document.getElementById('customerModal'),
            orderModal: document.getElementById('orderModal'),
            configModal: document.getElementById('configModal'),
            orderDetailModal: document.getElementById('orderDetailModal'),
            welcomeModal: document.getElementById('welcomeModal'),
            
            // Formularios
            productForm: document.getElementById('productForm'),
            customerForm: document.getElementById('customerForm'),
            configForm: document.getElementById('configForm'),
            welcomeForm: document.getElementById('welcomeForm'),
            
            // Elementos de datos
            ordersTableBody: document.getElementById('ordersTableBody'),
            productsGrid: document.getElementById('productsGrid'),
            customersTableBody: document.getElementById('customersTableBody'),
            
            // Elementos de orden
            customerSelector: document.getElementById('customerSelector'),
            orderProductsGrid: document.getElementById('orderProductsGrid'),
            orderSelectedProducts: document.getElementById('orderSelectedProducts'),
            orderSummary: document.getElementById('orderSummary'),
            
            // Notificación
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText')
        };

        // Datos iniciales (se cargan desde localStorage)
        let appData = {
            business: {
                name: "Snack Orders",
                logo: "",
                whatsapp: "+52 123 456 7890",
                address: "",
                rfc: ""
            },
            products: [],
            customers: [],
            orders: [],
            settings: {
                ivaRate: 0.16,
                currency: "MXN"
            }
        };

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadAppData();
            setupEventListeners();
            renderAllData();
            checkFirstUse();
        });

        // Cargar datos desde localStorage
        function loadAppData() {
            const savedData = localStorage.getItem('snackOrdersData');
            if (savedData) {
                appData = JSON.parse(savedData);
                updateBusinessInfo();
            }
        }

        // Guardar datos en localStorage
        function saveAppData() {
            localStorage.setItem('snackOrdersData', JSON.stringify(appData));
        }

        // Verificar si es el primer uso
        function checkFirstUse() {
            if (!localStorage.getItem('snackOrdersData')) {
                elements.welcomeModal.classList.add('active');
            } else {
                elements.welcomeModal.classList.remove('active');
            }
        }

        // Actualizar información del negocio en la UI
        function updateBusinessInfo() {
            document.getElementById('business-name').textContent = appData.business.name;
            document.getElementById('business-contact').textContent = `WhatsApp: ${appData.business.whatsapp}`;
            
            const logoElement = document.getElementById('logo');
            if (appData.business.logo) {
                logoElement.innerHTML = `<img src="${appData.business.logo}" alt="Logo" style="width:100%;height:100%;border-radius:50%;">`;
            } else {
                logoElement.textContent = appData.business.name.charAt(0);
            }
            
            // Actualizar también en el preview
            const logoPreview = document.getElementById('logoPreview');
            if (appData.business.logo) {
                logoPreview.innerHTML = `<img src="${appData.business.logo}" alt="Logo">`;
            } else {
                logoPreview.innerHTML = `<span>${appData.business.name.charAt(0)}</span>`;
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navegación por pestañas
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Botones principales
            elements.newProductBtn.addEventListener('click', () => openProductModal());
            elements.newCustomerBtn.addEventListener('click', () => openCustomerModal());
            elements.newOrderBtn.addEventListener('click', () => openOrderModal());
            elements.configBtn.addEventListener('click', () => openConfigModal());

            // Cerrar modales
            document.getElementById('closeProductModal').addEventListener('click', () => closeModal(elements.productModal));
            document.getElementById('closeCustomerModal').addEventListener('click', () => closeModal(elements.customerModal));
            document.getElementById('closeOrderModal').addEventListener('click', () => closeModal(elements.orderModal));
            document.getElementById('closeConfigModal').addEventListener('click', () => closeModal(elements.configModal));
            document.getElementById('closeOrderDetailModal').addEventListener('click', () => closeModal(elements.orderDetailModal));

            // Formularios
            elements.productForm.addEventListener('submit', saveProduct);
            elements.customerForm.addEventListener('submit', saveCustomer);
            elements.configForm.addEventListener('submit', saveConfig);
            elements.welcomeForm.addEventListener('submit', saveWelcomeConfig);

            // Gestión de datos
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
            document.getElementById('importFileInput').addEventListener('change', importData);

            // Orden - Paso 1: Cliente
            document.getElementById('selectCustomerBtn').addEventListener('click', goToStep2);
            document.getElementById('newCustomerInOrderBtn').addEventListener('click', () => {
                closeModal(elements.orderModal);
                openCustomerModal();
            });

            // Orden - Paso 2: Productos
            document.getElementById('backToStep1Btn').addEventListener('click', goToStep1);
            document.getElementById('goToStep3Btn').addEventListener('click', goToStep3);

            // Orden - Paso 3: Confirmación
            document.getElementById('backToStep2Btn').addEventListener('click', goToStep2FromStep3);
            document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);

            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });
        }

        // Cambiar pestaña
        function switchTab(tabId) {
            // Actualizar tabs
            elements.tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Actualizar contenido
            elements.tabContents.forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Recargar datos si es necesario
            if (tabId === 'orders') {
                renderOrders();
            } else if (tabId === 'products') {
                renderProducts();
            } else if (tabId === 'customers') {
                renderCustomers();
            }
        }

        // Renderizar todos los datos
        function renderAllData() {
            renderOrders();
            renderProducts();
            renderCustomers();
        }

        // Renderizar órdenes
        function renderOrders() {
            const ordersTableBody = elements.ordersTableBody;
            const emptyOrders = document.getElementById('emptyOrders');
            
            if (appData.orders.length === 0) {
                ordersTableBody.innerHTML = '';
                emptyOrders.style.display = 'block';
                return;
            }
            
            emptyOrders.style.display = 'none';
            
            // Ordenar por fecha (más reciente primero)
            const sortedOrders = [...appData.orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            sortedOrders.forEach(order => {
                const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado' };
                const total = calculateOrderTotal(order);
                const statusClass = `status-${order.status}`;
                const statusText = order.status === 'process' ? 'En proceso' : 
                                 order.status === 'completed' ? 'Completada' : 'Cancelada';
                
                html += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${customer.name}</td>
                        <td>${order.items.length} productos</td>
                        <td>$${total.toFixed(2)}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(order.date)}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewOrderDetail('${order.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${order.status === 'process' ? `
                                <button class="btn btn-sm btn-success" onclick="completeOrder('${order.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            ordersTableBody.innerHTML = html;
        }

        // Renderizar productos
        function renderProducts() {
            const productsGrid = elements.productsGrid;
            const emptyProducts = document.getElementById('emptyProducts');
            
            if (appData.products.length === 0) {
                productsGrid.innerHTML = '';
                emptyProducts.style.display = 'block';
                return;
            }
            
            emptyProducts.style.display = 'none';
            
            let html = '';
            appData.products.forEach(product => {
                html += `
                    <div class="product-card" data-id="${product.id}">
                        <div class="product-img">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 
                                `<i class="fas fa-hamburger"></i>`
                            }
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price.toFixed(2)}</div>
                            <div style="margin-top: 10px; display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')" style="flex:1;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')" style="flex:1;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            productsGrid.innerHTML = html;
        }

        // Renderizar clientes
        function renderCustomers() {
            const customersTableBody = elements.customersTableBody;
            const emptyCustomers = document.getElementById('emptyCustomers');
            
            if (appData.customers.length === 0) {
                customersTableBody.innerHTML = '';
                emptyCustomers.style.display = 'block';
                return;
            }
            
            emptyCustomers.style.display = 'none';
            
            let html = '';
            appData.customers.forEach(customer => {
                const orderCount = appData.orders.filter(order => order.customerId === customer.id).length;
                
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${orderCount} órdenes</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="editCustomer('${customer.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            customersTableBody.innerHTML = html;
        }

        // Abrir modal de producto
        function openProductModal(productId = null) {
            editingProductId = productId;
            const modalTitle = document.getElementById('productModalTitle');
            const form = elements.productForm;
            
            if (productId) {
                modalTitle.textContent = 'Editar Producto';
                const product = appData.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productImage').value = product.image || '';
                }
            } else {
                modalTitle.textContent = 'Nuevo Producto';
                form.reset();
                document.getElementById('productId').value = '';
            }
            
            elements.productModal.classList.add('active');
        }

        // Guardar producto
        function saveProduct(e) {
            e.preventDefault();
            
            const id = document.getElementById('productId').value || generateId();
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const image = document.getElementById('productImage').value;
            
            if (!name || isNaN(price)) {
                showNotification('Por favor, complete todos los campos requeridos', 'error');
                return;
            }
            
            const product = { id, name, price, image };
            
            if (editingProductId) {
                // Editar producto existente
                const index = appData.products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    appData.products[index] = product;
                }
            } else {
                // Agregar nuevo producto
                appData.products.push(product);
            }
            
            saveAppData();
            renderProducts();
            closeModal(elements.productModal);
            showNotification(`Producto ${editingProductId ? 'actualizado' : 'agregado'} correctamente`);
            
            // Si estamos en el proceso de crear una orden, actualizar la lista de productos
            if (elements.orderModal.classList.contains('active') && currentStep >= 2) {
                renderOrderProducts();
            }
        }

        // Eliminar producto
        function deleteProduct(productId) {
            if (confirm('¿Está seguro de eliminar este producto?')) {
                appData.products = appData.products.filter(p => p.id !== productId);
                saveAppData();
                renderProducts();
                showNotification('Producto eliminado correctamente');
            }
        }

        // Editar producto
        function editProduct(productId) {
            openProductModal(productId);
        }

        // Abrir modal de cliente
        function openCustomerModal(customerId = null) {
            editingCustomerId = customerId;
            const modalTitle = document.getElementById('customerModalTitle');
            const form = elements.customerForm;
            
            if (customerId) {
                modalTitle.textContent = 'Editar Cliente';
                const customer = appData.customers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone || '';
                }
            } else {
                modalTitle.textContent = 'Nuevo Cliente';
                form.reset();
                document.getElementById('customerId').value = '';
            }
            
            elements.customerModal.classList.add('active');
        }

        // Guardar cliente
        function saveCustomer(e) {
            e.preventDefault();
            
            const id = document.getElementById('customerId').value || generateId();
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            
            if (!name) {
                showNotification('Por favor, complete el nombre del cliente', 'error');
                return;
            }
            
            const customer = { id, name, phone };
            
            if (editingCustomerId) {
                // Editar cliente existente
                const index = appData.customers.findIndex(c => c.id === editingCustomerId);
                if (index !== -1) {
                    appData.customers[index] = customer;
                }
            } else {
                // Agregar nuevo cliente
                appData.customers.push(customer);
            }
            
            saveAppData();
            renderCustomers();
            closeModal(elements.customerModal);
            showNotification(`Cliente ${editingCustomerId ? 'actualizado' : 'agregado'} correctamente`);
            
            // Si estamos en el proceso de crear una orden, actualizar la selección de clientes
            if (elements.orderModal.classList.contains('active')) {
                renderCustomerSelector();
            }
        }

        // Eliminar cliente
        function deleteCustomer(customerId) {
            // Verificar si el cliente tiene órdenes
            const hasOrders = appData.orders.some(order => order.customerId === customerId);
            
            if (hasOrders) {
                if (!confirm('Este cliente tiene órdenes asociadas. ¿Está seguro de eliminar?')) {
                    return;
                }
            } else {
                if (!confirm('¿Está seguro de eliminar este cliente?')) {
                    return;
                }
            }
            
            appData.customers = appData.customers.filter(c => c.id !== customerId);
            saveAppData();
            renderCustomers();
            showNotification('Cliente eliminado correctamente');
        }

        // Editar cliente
        function editCustomer(customerId) {
            openCustomerModal(customerId);
        }

        // Abrir modal de orden
        function openOrderModal() {
            resetOrderModal();
            elements.orderModal.classList.add('active');
            renderCustomerSelector();
        }

        // Reiniciar modal de orden
        function resetOrderModal() {
            currentStep = 1;
            selectedCustomer = null;
            selectedProducts = {};
            
            // Resetear pasos
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step3').classList.remove('completed');
            
            // Mostrar paso 1, ocultar otros
            document.getElementById('orderStep1').style.display = 'block';
            document.getElementById('orderStep2').style.display = 'none';
            document.getElementById('orderStep3').style.display = 'none';
            
            // Deshabilitar botón de continuar
            document.getElementById('selectCustomerBtn').disabled = true;
            
            // Limpiar resumen
            updateOrderSummary();
        }

        // Renderizar selector de clientes
        function renderCustomerSelector() {
            const customerSelector = elements.customerSelector;
            
            if (appData.customers.length === 0) {
                customerSelector.innerHTML = '<p>No hay clientes registrados. Crea uno nuevo.</p>';
                return;
            }
            
            let html = '';
            appData.customers.forEach(customer => {
                const isSelected = selectedCustomer && selectedCustomer.id === customer.id;
                html += `
                    <div class="customer-card ${isSelected ? 'selected' : ''}" data-id="${customer.id}">
                        <div class="customer-name">${customer.name}</div>
                        <div class="customer-phone">${customer.phone || 'Sin teléfono'}</div>
                    </div>
                `;
            });
            
            customerSelector.innerHTML = html;
            
            // Agregar event listeners a las tarjetas de cliente
            document.querySelectorAll('.customer-card').forEach(card => {
                card.addEventListener('click', () => {
                    const customerId = card.getAttribute('data-id');
                    selectCustomer(customerId);
                });
            });
        }

        // Seleccionar cliente
        function selectCustomer(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (customer) {
                selectedCustomer = customer;
                
                // Actualizar UI
                document.querySelectorAll('.customer-card').forEach(card => {
                    if (card.getAttribute('data-id') === customerId) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
                
                // Habilitar botón de continuar
                document.getElementById('selectCustomerBtn').disabled = false;
            }
        }

        // Ir al paso 2 (productos)
        function goToStep2() {
            if (!selectedCustomer) {
                showNotification('Por favor, seleccione un cliente', 'error');
                return;
            }
            
            currentStep = 2;
            
            // Actualizar UI de pasos
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            
            // Mostrar paso 2
            document.getElementById('orderStep1').style.display = 'none';
            document.getElementById('orderStep2').style.display = 'block';
            
            // Renderizar productos para la orden
            renderOrderProducts();
        }

        // Renderizar productos para la orden
        function renderOrderProducts() {
            const orderProductsGrid = elements.orderProductsGrid;
            
            if (appData.products.length === 0) {
                orderProductsGrid.innerHTML = '<p>No hay productos disponibles. Agrega productos primero.</p>';
                return;
            }
            
            let html = '';
            appData.products.forEach(product => {
                const quantity = selectedProducts[product.id] ? selectedProducts[product.id].quantity : 0;
                const isSelected = quantity > 0;
                
                html += `
                    <div class="product-card ${isSelected ? 'selected' : ''}" data-id="${product.id}">
                        <div class="product-img">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 
                                `<i class="fas fa-hamburger"></i>`
                            }
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price.toFixed(2)}</div>
                            <div class="quantity-control" style="margin-top: 10px;">
                                <button class="quantity-btn" onclick="decreaseProductQuantity('${product.id}')">-</button>
                                <input type="number" class="quantity-input" value="${quantity}" min="0" readonly>
                                <button class="quantity-btn" onclick="increaseProductQuantity('${product.id}')">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            orderProductsGrid.innerHTML = html;
            
            // Actualizar productos seleccionados y resumen
            updateSelectedProductsList();
            updateOrderSummary();
        }

        // Aumentar cantidad de producto
        function increaseProductQuantity(productId) {
            if (!selectedProducts[productId]) {
                selectedProducts[productId] = {
                    productId,
                    quantity: 0,
                    price: 0
                };
            }
            
            selectedProducts[productId].quantity++;
            const product = appData.products.find(p => p.id === productId);
            if (product) {
                selectedProducts[productId].price = product.price;
            }
            
            // Actualizar UI
            updateProductCard(productId);
            updateSelectedProductsList();
            updateOrderSummary();
        }

        // Disminuir cantidad de producto
        function decreaseProductQuantity(productId) {
            if (selectedProducts[productId] && selectedProducts[productId].quantity > 0) {
                selectedProducts[productId].quantity--;
                
                if (selectedProducts[productId].quantity === 0) {
                    delete selectedProducts[productId];
                }
                
                // Actualizar UI
                updateProductCard(productId);
                updateSelectedProductsList();
                updateOrderSummary();
            }
        }

        // Actualizar tarjeta de producto
        function updateProductCard(productId) {
            const card = document.querySelector(`.product-card[data-id="${productId}"]`);
            if (card) {
                const quantity = selectedProducts[productId] ? selectedProducts[productId].quantity : 0;
                const input = card.querySelector('.quantity-input');
                if (input) {
                    input.value = quantity;
                }
                
                if (quantity > 0) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            }
        }

        // Actualizar lista de productos seleccionados
        function updateSelectedProductsList() {
            const orderSelectedProducts = elements.orderSelectedProducts;
            
            // Filtrar productos con cantidad > 0
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            
            if (productsWithQuantity.length === 0) {
                orderSelectedProducts.innerHTML = '<p>No hay productos seleccionados. Agrega productos a la orden.</p>';
                return;
            }
            
            let html = '';
            productsWithQuantity.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId);
                if (product) {
                    const subtotal = item.quantity * product.price;
                    html += `
                        <div class="product-order-item">
                            <div class="product-order-info">
                                <div><strong>${product.name}</strong></div>
                                <div>$${product.price.toFixed(2)} x ${item.quantity} = $${subtotal.toFixed(2)}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="removeProductFromOrder('${item.productId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            orderSelectedProducts.innerHTML = html;
        }

        // Eliminar producto de la orden
        function removeProductFromOrder(productId) {
            delete selectedProducts[productId];
            updateProductCard(productId);
            updateSelectedProductsList();
            updateOrderSummary();
        }

        // Actualizar resumen de la orden
        function updateOrderSummary() {
            // Calcular subtotal
            let subtotal = 0;
            Object.values(selectedProducts).forEach(item => {
                const product = appData.products.find(p => p.id === item.productId);
                if (product) {
                    subtotal += item.quantity * product.price;
                }
            });
            
            // Calcular IVA y total
            const iva = subtotal * appData.settings.ivaRate;
            const total = subtotal + iva;
            
            // Actualizar UI
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            
            // Actualizar también para confirmación
            document.getElementById('confirmSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('confirmIva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('confirmTotal').textContent = `$${total.toFixed(2)}`;
            
            // Habilitar/deshabilitar botón de continuar
            document.getElementById('goToStep3Btn').disabled = subtotal === 0;
        }

        // Ir al paso 3 (confirmación)
        function goToStep3() {
            // Verificar que hay productos seleccionados
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            if (productsWithQuantity.length === 0) {
                showNotification('Por favor, agregue al menos un producto a la orden', 'error');
                return;
            }
            
            currentStep = 3;
            
            // Actualizar UI de pasos
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            
            // Mostrar paso 3
            document.getElementById('orderStep2').style.display = 'none';
            document.getElementById('orderStep3').style.display = 'block';
            
            // Actualizar información de confirmación
            updateConfirmationInfo();
        }

        // Actualizar información de confirmación
        function updateConfirmationInfo() {
            // Información del cliente
            document.getElementById('confirmCustomerName').textContent = selectedCustomer.name;
            document.getElementById('confirmCustomerPhone').textContent = selectedCustomer.phone || '-';
            
            // Lista de productos
            const confirmProductsList = document.getElementById('confirmProductsList');
            let html = '';
            
            Object.values(selectedProducts).forEach(item => {
                if (item.quantity > 0) {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        const subtotal = item.quantity * product.price;
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    ${product.name} (${item.quantity} x $${product.price.toFixed(2)})
                                </div>
                                <div>$${subtotal.toFixed(2)}</div>
                            </div>
                        `;
                    }
                }
            });
            
            confirmProductsList.innerHTML = html;
        }

        // Volver al paso 1 desde el paso 2
        function goToStep1() {
            currentStep = 1;
            
            // Actualizar UI de pasos
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            
            // Mostrar paso 1
            document.getElementById('orderStep1').style.display = 'block';
            document.getElementById('orderStep2').style.display = 'none';
        }

        // Volver al paso 2 desde el paso 3
        function goToStep2FromStep3() {
            currentStep = 2;
            
            // Actualizar UI de pasos
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.remove('completed');
            
            // Mostrar paso 2
            document.getElementById('orderStep2').style.display = 'block';
            document.getElementById('orderStep3').style.display = 'none';
        }

        // Guardar orden
        function saveOrder() {
            // Verificar que hay productos seleccionados
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            if (productsWithQuantity.length === 0) {
                showNotification('Por favor, agregue al menos un producto a la orden', 'error');
                return;
            }
            
            // Crear objeto de orden
            const orderId = generateId();
            const order = {
                id: orderId,
                customerId: selectedCustomer.id,
                items: productsWithQuantity.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    price: item.price
                })),
                status: 'process',
                date: new Date().toISOString()
            };
            
            // Agregar orden a los datos
            appData.orders.push(order);
            saveAppData();
            
            // Cerrar modal y mostrar notificación
            closeModal(elements.orderModal);
            showNotification(`Orden #${orderId} creada correctamente`);
            
            // Cambiar a pestaña de órdenes y actualizar
            switchTab('orders');
            
            // Generar PDF automáticamente
            setTimeout(() => generateOrderPDF(orderId), 500);
        }

        // Ver detalles de orden
        function viewOrderDetail(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado', phone: '' };
            const total = calculateOrderTotal(order);
            
            // Actualizar título
            document.getElementById('detailOrderId').textContent = orderId;
            
            // Construir contenido
            let html = `
                <div class="order-detail-card">
                    <h4>Cliente: ${customer.name}</h4>
                    <p>Teléfono: ${customer.phone || '-'}</p>
                    <p>Fecha: ${formatDate(order.date)}</p>
                    <p>Estado: <span class="status status-${order.status}">
                        ${order.status === 'process' ? 'En proceso' : 
                          order.status === 'completed' ? 'Completada' : 'Cancelada'}
                    </span></p>
                    
                    <h4 style="margin-top: 20px;">Productos:</h4>
            `;
            
            order.items.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId) || { name: 'Producto no encontrado', price: 0 };
                const itemTotal = item.quantity * item.price;
                
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>
                            ${product.name} (${item.quantity} x $${item.price.toFixed(2)})
                        </div>
                        <div>$${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            });
            
            const subtotal = total / (1 + appData.settings.ivaRate);
            const iva = subtotal * appData.settings.ivaRate;
            
            html += `
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <div>Subtotal:</div>
                            <div>$${subtotal.toFixed(2)}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <div>IVA (${(appData.settings.ivaRate * 100)}%):</div>
                            <div>$${iva.toFixed(2)}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; font-weight: bold; font-size: 18px; color: var(--primary);">
                            <div>Total:</div>
                            <div>$${total.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateOrderPDF('${orderId}')">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </button>
                    
                    ${order.status === 'process' ? `
                        <button class="btn btn-success" onclick="completeOrder('${orderId}')">
                            <i class="fas fa-check"></i> Marcar como Completada
                        </button>
                        <button class="btn btn-danger" onclick="cancelOrder('${orderId}')">
                            <i class="fas fa-times"></i> Cancelar Orden
                        </button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('orderDetailContent').innerHTML = html;
            elements.orderDetailModal.classList.add('active');
        }

        // Completar orden
        function completeOrder(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'completed';
                saveAppData();
                renderOrders();
                
                // Si el modal de detalles está abierto, actualizarlo
                if (elements.orderDetailModal.classList.contains('active')) {
                    viewOrderDetail(orderId);
                }
                
                showNotification(`Orden #${orderId} marcada como completada`);
            }
        }

        // Cancelar orden
        function cancelOrder(orderId) {
            if (confirm('¿Está seguro de cancelar esta orden?')) {
                const order = appData.orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    saveAppData();
                    renderOrders();
                    
                    // Si el modal de detalles está abierto, actualizarlo
                    if (elements.orderDetailModal.classList.contains('active')) {
                        viewOrderDetail(orderId);
                    }
                    
                    showNotification(`Orden #${orderId} cancelada`);
                }
            }
        }

        // Eliminar orden
        function deleteOrder(orderId) {
            if (confirm('¿Está seguro de eliminar esta orden?')) {
                appData.orders = appData.orders.filter(o => o.id !== orderId);
                saveAppData();
                renderOrders();
                showNotification('Orden eliminada correctamente');
            }
        }

        // Generar PDF de orden
        function generateOrderPDF(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado', phone: '' };
            const total = calculateOrderTotal(order);
            const subtotal = total / (1 + appData.settings.ivaRate);
            const iva = subtotal * appData.settings.ivaRate;
            
            // Crear contenido HTML para el PDF
            const pdfContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 24px; font-weight: bold; color: #FF6B35;">${appData.business.name}</div>
                        <div style="margin-top: 10px;">${appData.business.address || ''}</div>
                        <div>WhatsApp: ${appData.business.whatsapp}</div>
                        ${appData.business.rfc ? `<div>RFC: ${appData.business.rfc}</div>` : ''}
                    </div>
                    
                    <div style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="margin: 0; color: #004E89;">COTIZACIÓN #${orderId}</h1>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div>
                                <div><strong>Fecha:</strong> ${formatDate(order.date)}</div>
                                <div><strong>Estado:</strong> ${order.status === 'process' ? 'En proceso' : 
                                                               order.status === 'completed' ? 'Completada' : 'Cancelada'}</div>
                            </div>
                            <div>
                                <div><strong>Cliente:</strong> ${customer.name}</div>
                                <div><strong>Teléfono:</strong> ${customer.phone || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Producto</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Precio Unitario</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Cantidad</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let itemsHTML = '';
            order.items.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId) || { name: 'Producto no encontrado', price: 0 };
                const itemTotal = item.quantity * item.price;
                
                itemsHTML += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #ddd;">${product.name}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">$${item.price.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">${item.quantity}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">$${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            const pdfFooter = `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; float: right; width: 300px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                            <div>Subtotal:</div>
                            <div>$${subtotal.toFixed(2)}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                            <div>IVA (${(appData.settings.ivaRate * 100)}%):</div>
                            <div>$${iva.toFixed(2)}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 15px 0; font-weight: bold; font-size: 18px; border-top: 2px solid #333;">
                            <div>TOTAL:</div>
                            <div>$${total.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div style="clear: both; margin-top: 100px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
                        <div>${appData.business.name} • ${appData.business.whatsapp} • ${appData.business.address || ''}</div>
                        <div>¡Gracias por su preferencia!</div>
                    </div>
                </div>
            `;
            
            const fullPdfContent = pdfContent + itemsHTML + pdfFooter;
            
            // Crear ventana para el PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cotización #${orderId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${fullPdfContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            showNotification('PDF generado correctamente. Se abrirá en una nueva ventana para imprimir.');
        }

        // Abrir modal de configuración
        function openConfigModal() {
            // Cargar valores actuales
            document.getElementById('configBusinessName').value = appData.business.name;
            document.getElementById('configLogo').value = appData.business.logo || '';
            document.getElementById('configWhatsApp').value = appData.business.whatsapp;
            document.getElementById('configAddress').value = appData.business.address || '';
            document.getElementById('configRFC').value = appData.business.rfc || '';
            
            // Actualizar preview del logo
            const logoPreview = document.getElementById('logoPreview');
            if (appData.business.logo) {
                logoPreview.innerHTML = `<img src="${appData.business.logo}" alt="Logo">`;
            } else {
                logoPreview.innerHTML = `<span>${appData.business.name.charAt(0)}</span>`;
            }
            
            elements.configModal.classList.add('active');
        }

        // Guardar configuración
        function saveConfig(e) {
            e.preventDefault();
            
            appData.business.name = document.getElementById('configBusinessName').value;
            appData.business.logo = document.getElementById('configLogo').value;
            appData.business.whatsapp = document.getElementById('configWhatsApp').value;
            appData.business.address = document.getElementById('configAddress').value;
            appData.business.rfc = document.getElementById('configRFC').value;
            
            saveAppData();
            updateBusinessInfo();
            closeModal(elements.configModal);
            showNotification('Configuración guardada correctamente');
        }

        // Guardar configuración de bienvenida
        function saveWelcomeConfig(e) {
            e.preventDefault();
            
            appData.business.name = document.getElementById('welcomeBusinessName').value;
            appData.business.whatsapp = document.getElementById('welcomeWhatsApp').value;
            
            saveAppData();
            updateBusinessInfo();
            closeModal(elements.welcomeModal);
            showNotification('¡Configuración completada! Ya puedes usar el sistema.');
        }

        // Exportar datos
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `snack-orders-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Datos exportados correctamente');
        }

        // Importar datos
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validar estructura básica
                    if (importedData.business && importedData.products && importedData.customers && importedData.orders) {
                        if (confirm('¿Está seguro de importar estos datos? Se sobrescribirán los datos actuales.')) {
                            appData = importedData;
                            saveAppData();
                            renderAllData();
                            updateBusinessInfo();
                            showNotification('Datos importados correctamente');
                        }
                    } else {
                        showNotification('El archivo no tiene un formato válido', 'error');
                    }
                } catch (error) {
                    showNotification('Error al importar datos: ' + error.message, 'error');
                }
                
                // Limpiar input
                document.getElementById('importFileInput').value = '';
            };
            reader.readAsText(file);
        }

        // Borrar todos los datos
        function clearData() {
            if (confirm('¿Está seguro de borrar todos los datos? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('snackOrdersData');
                appData = {
                    business: {
                        name: "Snack Orders",
                        logo: "",
                        whatsapp: "+52 123 456 7890",
                        address: "",
                        rfc: ""
                    },
                    products: [],
                    customers: [],
                    orders: [],
                    settings: {
                        ivaRate: 0.16,
                        currency: "MXN"
                    }
                };
                
                renderAllData();
                updateBusinessInfo();
                showNotification('Todos los datos han sido borrados');
            }
        }

        // Cerrar modal
        function closeModal(modal) {
            modal.classList.remove('active');
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            elements.notificationText.textContent = message;
            elements.notification.className = 'notification';
            elements.notification.classList.add(type);
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // Funciones utilitarias
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function calculateOrderTotal(order) {
            let subtotal = 0;
            order.items.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            return subtotal + (subtotal * appData.settings.ivaRate);
        }

        // Hacer funciones disponibles globalmente para onclick
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.viewOrderDetail = viewOrderDetail;
        window.completeOrder = completeOrder;
        window.cancelOrder = cancelOrder;
        window.deleteOrder = deleteOrder;
        window.generateOrderPDF = generateOrderPDF;
        window.increaseProductQuantity = increaseProductQuantity;
        window.decreaseProductQuantity = decreaseProductQuantity;
        window.removeProductFromOrder = removeProductFromOrder;
    </script>
</body>
</html>