<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snack Orders - Sistema de Comandas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #004E89;
            --light: #F8F9FA;
            --dark: #212529;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --background-color: #f5f7fa;
            --text-color: #212529;
            --card-background: white;
            --button-text: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* ========== HEADER MEJORADO ========== */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            padding: 15px;
            gap: 15px;
            min-height: 80px;
        }

        .logo-container {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: var(--transition);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .business-info {
            flex: 1;
            min-width: 0;
        }

        .business-info h1 {
            font-size: 20px;
            margin-bottom: 4px;
            font-weight: 700;
            letter-spacing: -0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .business-info p {
            opacity: 0.9;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .business-info i {
            font-size: 12px;
        }

        .config-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .config-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .config-btn i {
            font-size: 16px;
        }

        /* ========== TABS MEJORADAS ========== */
        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 5px;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 14px 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
            border-radius: 8px;
            margin: 0 2px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.08);
        }

        .tab.active {
            color: var(--primary);
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.1);
            position: relative;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 3px;
            background-color: var(--primary);
            border-radius: 2px;
        }

        .tab-content {
            display: none;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== BOTONES RESPONSIVE ========== */
        .section-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--secondary);
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
        }

        .section-title span {
            font-weight: 700;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--button-text);
            font-size: 14px;
            min-height: 44px;
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 107, 53, 0.3);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
            min-height: 36px;
        }

        /* ========== MEJORAS PARA MÓVILES ========== */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--border-radius);
            background: var(--card-background);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        th {
            background-color: rgba(0, 0, 0, 0.02);
            font-weight: 600;
            color: var(--secondary);
            font-size: 14px;
        }

        tr:hover {
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.03);
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 100px;
            text-align: center;
        }

        .actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .actions .btn-sm {
            padding: 6px 10px;
            min-width: 36px;
        }

        /* ========== MODALES RESPONSIVE ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--card-background);
            z-index: 1;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--text-color);
            margin: 0;
        }

        /* ========== PRODUCT GRID RESPONSIVE ========== */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
            background-color: var(--card-background);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .product-img {
            height: 120px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--primary);
        }

        .product-info {
            padding: 12px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-price {
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
        }

        /* ========== MEDIA QUERIES ========== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-content {
                flex-wrap: wrap;
                padding: 12px;
                gap: 12px;
                min-height: auto;
            }
            
            .logo {
                width: 50px;
                height: 50px;
                font-size: 20px;
                border-radius: 10px;
            }
            
            .business-info h1 {
                font-size: 18px;
            }
            
            .business-info p {
                font-size: 12px;
            }
            
            .config-btn {
                padding: 8px 12px;
                font-size: 13px;
                margin-left: auto;
            }
            
            .config-btn span {
                display: none;
            }
            
            .config-btn i {
                font-size: 18px;
                margin: 0;
            }
            
            .tabs {
                padding: 4px;
            }
            
            .tab {
                min-width: 100px;
                padding: 12px 8px;
                font-size: 13px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .section-title {
                font-size: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .section-title .btn {
                width: 100%;
                justify-content: center;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .product-img {
                height: 100px;
            }
            
            .table-container {
                border-radius: 8px;
                margin: 15px -10px;
                width: calc(100% + 20px);
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                max-height: 90vh;
            }
            
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .actions .btn-sm {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                width: 70px;
                height: 70px;
                font-size: 24px;
                margin: 0 auto;
            }
            
            .business-info {
                width: 100%;
                text-align: center;
            }
            
            .business-info h1 {
                font-size: 20px;
            }
            
            .config-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(255,255,255,0.25);
            }
            
            .config-btn span {
                display: none;
            }
            
            .tabs {
                flex-wrap: nowrap;
                justify-content: flex-start;
            }
            
            .tab {
                flex: 0 0 auto;
                padding: 12px 15px;
            }
            
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                width: 100%;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 360px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .business-info h1 {
                font-size: 18px;
            }
        }

        /* ========== ESTILOS EXISTENTES MANTENIDOS ========== */
        .status-process {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 255, 107, 53), 0.2);
        }

        .order-summary {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }

        .order-summary h3 {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            border-bottom: none;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .quantity-btn:hover {
            background-color: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .step-container {
            display: flex;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .step {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .step.active .step-number {
            background-color: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--success);
            color: white;
        }

        .step-text {
            font-weight: 600;
            color: #6c757d;
        }

        .step.active .step-text {
            color: var(--primary);
        }

        .step.completed .step-text {
            color: var(--success);
        }

        .step-line {
            flex: 1;
            height: 3px;
            background-color: #e9ecef;
            margin: 0 10px;
        }

        .step.completed .step-line {
            background-color: var(--success);
        }

        .customer-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .customer-card {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--card-background);
        }

        .customer-card:hover {
            border-color: var(--primary);
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.05);
        }

        .customer-card.selected {
            border-color: var(--primary);
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.1);
        }

        .customer-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .customer-phone {
            color: #6c757d;
            font-size: 14px;
        }

        .order-products {
            margin-top: 20px;
        }

        .product-order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .product-order-info {
            flex: 1;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            background-color: var(--dark);
            color: white;
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            margin: 0 auto 20px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-screen h1 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .welcome-screen p {
            margin-bottom: 30px;
            color: #6c757d;
        }

        .order-detail-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        /* Nuevos estilos para paleta de colores */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .color-option {
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .color-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .color-option.selected {
            border-color: var(--primary);
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.05);
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 2px solid #ddd;
        }

        /* Estilos para reportes */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .report-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .report-card i {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .report-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .report-card p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .chart-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .report-detail {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .import-options {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }

        .import-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .theme-preset {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .theme-preset:hover {
            border-color: var(--primary);
            background-color: rgba(var(--primary-rgb, 255, 107, 53), 0.05);
        }

        @media (max-width: 768px) {
            .step-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .step-line {
                display: none;
            }
            
            .report-grid {
                grid-template-columns: 1fr;
            }
            
            .data-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo" id="logo">S</div>
                </div>
                <div class="business-info">
                    <h1 id="business-name">Snack Orders</h1>
                    <p id="business-contact">
                        <i class="fab fa-whatsapp"></i> +52 123 456 7890
                    </p>
                </div>
                <button class="config-btn" id="configBtn" title="Configuración del sistema">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="orders">
                <i class="fas fa-clipboard-list"></i> Comandas
            </div>
            <div class="tab" data-tab="products">
                <i class="fas fa-hamburger"></i> Productos
            </div>
            <div class="tab" data-tab="customers">
                <i class="fas fa-users"></i> Clientes
            </div>
            <div class="tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i> Reportes
            </div>
        </div>

        <!-- Contenido de la pestaña Comandas -->
        <div class="tab-content active" id="orders-content">
            <div class="section-title">
                <span>Gestión de Comandas</span>
                <button class="btn btn-primary" id="newOrderBtn" title="Crear nueva orden">
                    <i class="fas fa-plus"></i> Nueva Orden
                </button>
            </div>
            
            <div class="table-container">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Las órdenes se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyOrders">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No hay comandas registradas</h3>
                    <p>Crea tu primera comanda haciendo clic en "Nueva Orden"</p>
                </div>
            </div>
        </div>

        <!-- Contenido de la pestaña Productos -->
        <div class="tab-content" id="products-content">
            <div class="section-title">
                <span>Catálogo de Productos</span>
                <button class="btn btn-primary" id="newProductBtn" title="Agregar nuevo producto">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </button>
            </div>
            
            <div class="product-grid" id="productsGrid">
                <!-- Los productos se cargarán aquí dinámicamente -->
            </div>
            <div class="empty-state" id="emptyProducts">
                <i class="fas fa-hamburger"></i>
                <h3>No hay productos registrados</h3>
                <p>Agrega tu primer producto haciendo clic en "Nuevo Producto"</p>
            </div>
        </div>

        <!-- Contenido de la pestaña Clientes -->
        <div class="tab-content" id="customers-content">
            <div class="section-title">
                <span>Base de Clientes</span>
                <button class="btn btn-primary" id="newCustomerBtn" title="Agregar nuevo cliente">
                    <i class="fas fa-plus"></i> Nuevo Cliente
                </button>
            </div>
            
            <div class="table-container">
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Órdenes</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        <!-- Los clientes se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyCustomers">
                    <i class="fas fa-users"></i>
                    <h3>No hay clientes registrados</h3>
                    <p>Agrega tu primer cliente haciendo clic en "Nuevo Cliente"</p>
                </div>
            </div>
        </div>

        <!-- Nueva pestaña de Reportes -->
        <div class="tab-content" id="reports-content">
            <div class="section-title">
                <span>Reportes y Estadísticas</span>
                <button class="btn btn-primary" id="refreshReportsBtn" title="Actualizar reportes">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
            
            <div class="report-grid" id="reportsGrid">
                <div class="report-card" onclick="generateReport('sales')">
                    <i class="fas fa-chart-line"></i>
                    <h3>Ventas por Período</h3>
                    <p>Análisis de ventas diarias, semanales y mensuales</p>
                    <button class="btn btn-sm btn-primary">Ver Reporte</button>
                </div>
                
                <div class="report-card" onclick="generateReport('products')">
                    <i class="fas fa-star"></i>
                    <h3>Productos Más Vendidos</h3>
                    <p>Top 10 productos por volumen de ventas</p>
                    <button class="btn btn-sm btn-primary">Ver Reporte</button>
                </div>
                
                <div class="report-card" onclick="generateReport('customers')">
                    <i class="fas fa-crown"></i>
                    <h3>Clientes Más Frecuentes</h3>
                    <p>Clientes con mayor número de pedidos</p>
                    <button class="btn btn-sm btn-primary">Ver Reporte</button>
                </div>
                
                <div class="report-card" onclick="generateReport('financial')">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>Estado Financiero</h3>
                    <p>Ingresos, gastos y ganancias netas</p>
                    <button class="btn btn-sm btn-primary">Ver Reporte</button>
                </div>
                
                <div class="report-card" onclick="generateReport('trends')">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Tendencias de Ventas</h3>
                    <p>Análisis de tendencias y pronósticos</p>
                    <button class="btn btn-sm btn-primary">Ver Reporte</button>
                </div>
            </div>
            
            <div id="reportDetailContainer" style="display: none;">
                <div class="report-detail" id="reportDetail">
                    <!-- Los detalles del reporte se cargarán aquí dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Modal para crear/editar producto -->
        <div class="modal" id="productModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="productModalTitle">Nuevo Producto</h2>
                    <button class="btn btn-secondary btn-sm" id="closeProductModal" title="Cerrar">X</button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="form-group">
                            <label for="productName">Nombre del producto *</label>
                            <input type="text" id="productName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Precio unitario *</label>
                            <input type="number" id="productPrice" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productImage">URL de la imagen (opcional)</label>
                            <input type="text" id="productImage" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                            <small>Si no se proporciona, se usará una imagen por defecto</small>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para crear/editar cliente -->
        <div class="modal" id="customerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="customerModalTitle">Nuevo Cliente</h2>
                    <button class="btn btn-secondary btn-sm" id="closeCustomerModal" title="Cerrar">X</button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="form-group">
                            <label for="customerName">Nombre completo *</label>
                            <input type="text" id="customerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Teléfono (opcional)</label>
                            <input type="tel" id="customerPhone" class="form-control" placeholder="+52 123 456 7890">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para crear nueva orden -->
        <div class="modal" id="orderModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="orderModalTitle">Nueva Orden</h2>
                    <button class="btn btn-secondary btn-sm" id="closeOrderModal" title="Cerrar">X</button>
                </div>
                <div class="modal-body">
                    <div class="step-container">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-text">Cliente</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-text">Productos</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <div class="step-text">Confirmar</div>
                        </div>
                    </div>

                    <!-- Paso 1: Selección de cliente -->
                    <div id="orderStep1" class="order-step">
                        <h3>Seleccionar cliente</h3>
                        <p>Elige un cliente existente o crea uno nuevo</p>
                        
                        <div class="customer-selector" id="customerSelector">
                            <!-- Los clientes se cargarán aquí dinámicamente -->
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" id="selectCustomerBtn" disabled>
                                <i class="fas fa-user"></i> Usar este cliente
                            </button>
                            <button class="btn btn-secondary" id="newCustomerInOrderBtn">
                                <i class="fas fa-plus"></i> Crear nuevo cliente
                            </button>
                        </div>
                    </div>

                    <!-- Paso 2: Selección de productos -->
                    <div id="orderStep2" class="order-step" style="display: none;">
                        <h3>Seleccionar productos</h3>
                        <p>Elige los productos y cantidades para la orden</p>
                        
                        <div class="product-grid" id="orderProductsGrid">
                            <!-- Los productos para la orden se cargarán aquí dinámicamente -->
                        </div>
                        
                        <div class="order-products" id="orderSelectedProducts">
                            <!-- Los productos seleccionados se mostrarán aquí -->
                        </div>
                        
                        <div class="order-summary" id="orderSummary">
                            <h3>Resumen de la orden</h3>
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>IVA (16%):</span>
                                <span id="iva">$0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">$0.00</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button class="btn btn-secondary" id="backToStep1Btn">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button class="btn btn-primary" id="goToStep3Btn">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Paso 3: Confirmación -->
                    <div id="orderStep3" class="order-step" style="display: none;">
                        <h3>Confirmar orden</h3>
                        <p>Revisa los detalles de la orden antes de guardar</p>
                        
                        <div class="order-detail-card">
                            <h4>Cliente: <span id="confirmCustomerName">-</span></h4>
                            <p>Teléfono: <span id="confirmCustomerPhone">-</span></p>
                            
                            <h4 style="margin-top: 20px;">Productos:</h4>
                            <div id="confirmProductsList">
                                <!-- Los productos confirmados se mostrarán aquí -->
                            </div>
                            
                            <div class="order-summary" style="margin-top: 20px;">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span id="confirmSubtotal">$0.00</span>
                                </div>
                                <div class="summary-row">
                                    <span>IVA (16%):</span>
                                    <span id="confirmIva">$0.00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span id="confirmTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button class="btn btn-secondary" id="backToStep2Btn">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button class="btn btn-success" id="saveOrderBtn">
                                <i class="fas fa-check"></i> Guardar Orden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de configuración mejorado -->
        <div class="modal" id="configModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>Configuración del Sistema</h2>
                    <button class="btn btn-secondary btn-sm" id="closeConfigModal" title="Cerrar">X</button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <div class="form-group">
                            <label>Logo del negocio</label>
                            <div class="logo-preview" id="logoPreview">
                                <span>S</span>
                            </div>
                            <input type="text" id="configLogo" class="form-control" placeholder="URL del logo (opcional)">
                            <small>Recomendado: 200x200px, formato PNG o JPG</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="configBusinessName">Nombre del negocio *</label>
                            <input type="text" id="configBusinessName" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="configWhatsApp">Número de WhatsApp *</label>
                            <input type="text" id="configWhatsApp" class="form-control" required placeholder="+52 123 456 7890">
                        </div>
                        
                        <div class="form-group">
                            <label for="configAddress">Dirección (opcional)</label>
                            <input type="text" id="configAddress" class="form-control" placeholder="Calle y número, Ciudad, Estado">
                        </div>
                        
                        <div class="form-group">
                            <label for="configRFC">RFC (opcional)</label>
                            <input type="text" id="configRFC" class="form-control" placeholder="RFC para facturación">
                        </div>
                        
                        <hr style="margin: 30px 0;">
                        
                        <h3>Personalización de Colores</h3>
                        <p>Cambia la apariencia del sistema</p>
                        
                        <div class="color-palette">
                            <div class="color-option" onclick="selectColorTheme('default')">
                                <div class="color-preview" style="background: #FF6B35;"></div>
                                <div>Por defecto</div>
                            </div>
                            <div class="color-option" onclick="selectColorTheme('professional')">
                                <div class="color-preview" style="background: #2C3E50;"></div>
                                <div>Profesional</div>
                            </div>
                            <div class="color-option" onclick="selectColorTheme('modern')">
                                <div class="color-preview" style="background: #3498DB;"></div>
                                <div>Moderno</div>
                            </div>
                            <div class="color-option" onclick="selectColorTheme('vibrant')">
                                <div class="color-preview" style="background: #9B59B6;"></div>
                                <div>Vibrante</div>
                            </div>
                            <div class="color-option" onclick="selectColorTheme('dark')">
                                <div class="color-preview" style="background: #34495E;"></div>
                                <div>Oscuro</div>
                            </div>
                            <div class="color-option" onclick="selectColorTheme('custom')">
                                <div class="color-preview" id="customColorPreview" style="background: #FF6B35;"></div>
                                <div>Personalizado</div>
                            </div>
                        </div>
                        
                        <div id="customColorControls" style="margin-top: 20px; display: none;">
                            <h4>Colores personalizados:</h4>
                            <div class="color-input-group">
                                <label>Primario:</label>
                                <input type="color" id="colorPrimary" value="#FF6B35" class="color-input">
                                <input type="text" id="colorPrimaryText" value="#FF6B35" class="form-control" style="width: 100px;">
                            </div>
                            <div class="color-input-group">
                                <label>Secundario:</label>
                                <input type="color" id="colorSecondary" value="#004E89" class="color-input">
                                <input type="text" id="colorSecondaryText" value="#004E89" class="form-control" style="width: 100px;">
                            </div>
                            <div class="color-input-group">
                                <label>Fondo:</label>
                                <input type="color" id="colorBackground" value="#f5f7fa" class="color-input">
                                <input type="text" id="colorBackgroundText" value="#f5f7fa" class="form-control" style="width: 100px;">
                            </div>
                            <div class="color-input-group">
                                <label>Texto:</label>
                                <input type="color" id="colorText" value="#212529" class="color-input">
                                <input type="text" id="colorTextText" value="#212529" class="form-control" style="width: 100px;">
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="applyCustomColors()" style="margin-top: 10px;">
                                <i class="fas fa-paint-brush"></i> Aplicar Colores
                            </button>
                        </div>
                        
                        <hr style="margin: 30px 0;">
                        
                        <h3>Gestión de datos</h3>
                        <p>Exporta o importa todos los datos del sistema</p>
                        
                        <div class="data-actions">
                            <button type="button" class="btn btn-secondary" id="exportDataBtn" title="Exportar todos los datos">
                                <i class="fas fa-download"></i> Exportar Datos
                            </button>
                            <button type="button" class="btn btn-secondary" id="importDataBtn" title="Importar datos desde archivo">
                                <i class="fas fa-upload"></i> Importar Datos
                            </button>
                            <button type="button" class="btn btn-danger" id="clearDataBtn" title="Borrar todos los datos">
                                <i class="fas fa-trash"></i> Borrar Todo
                            </button>
                        </div>
                        
                        <div class="import-options" id="importOptions" style="display: none;">
                            <h4>Opciones de importación:</h4>
                            <p>Selecciona qué datos quieres importar:</p>
                            <div class="import-option">
                                <input type="checkbox" id="importProducts" checked>
                                <label for="importProducts">Productos</label>
                            </div>
                            <div class="import-option">
                                <input type="checkbox" id="importCustomers" checked>
                                <label for="importCustomers">Clientes</label>
                            </div>
                            <div class="import-option">
                                <input type="checkbox" id="importOrders" checked>
                                <label for="importOrders">Órdenes</label>
                            </div>
                            <div class="import-option">
                                <input type="checkbox" id="importBusiness" checked>
                                <label for="importBusiness">Configuración del negocio</label>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" id="confirmImportBtn" style="margin-top: 10px;">
                                <i class="fas fa-check"></i> Confirmar Importación
                            </button>
                        </div>
                        
                        <input type="file" id="importFileInput" style="display: none;" accept=".json">
                        
                        <div class="form-group" style="margin-top: 30px;">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de detalles de orden -->
        <div class="modal" id="orderDetailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Detalles de la Orden #<span id="detailOrderId"></span></h2>
                    <button class="btn btn-secondary btn-sm" id="closeOrderDetailModal" title="Cerrar">X</button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailContent">
                        <!-- Los detalles de la orden se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Pantalla de bienvenida (solo para primer uso) -->
        <div class="modal active" id="welcomeModal">
            <div class="modal-content">
                <div class="welcome-screen">
                    <div class="logo-preview">
                        <span>S</span>
                    </div>
                    <h1>¡Bienvenido a Snack Orders!</h1>
                    <p>Configura tu sistema de comandas para comenzar a gestionar pedidos de manera eficiente.</p>
                    <p>Primero, necesitamos algunos datos básicos de tu negocio.</p>
                    
                    <form id="welcomeForm" style="text-align: left; margin-top: 30px;">
                        <div class="form-group">
                            <label for="welcomeBusinessName">Nombre de tu negocio *</label>
                            <input type="text" id="welcomeBusinessName" class="form-control" required placeholder="Ej: Snacks Deliciosos">
                        </div>
                        
                        <div class="form-group">
                            <label for="welcomeWhatsApp">Número de WhatsApp *</label>
                            <input type="text" id="welcomeWhatsApp" class="form-control" required placeholder="+52 123 456 7890">
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-check"></i> Comenzar a usar el sistema
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notificación -->
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notificationText">Operación realizada con éxito</span>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        let selectedCustomer = null;
        let selectedProducts = {};
        let editingProductId = null;
        let editingCustomerId = null;
        let editingOrderId = null;
        let currentReport = null;
        let importDataBuffer = null;

        // Elementos del DOM
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            newOrderBtn: document.getElementById('newOrderBtn'),
            newProductBtn: document.getElementById('newProductBtn'),
            newCustomerBtn: document.getElementById('newCustomerBtn'),
            configBtn: document.getElementById('configBtn'),
            refreshReportsBtn: document.getElementById('refreshReportsBtn'),
            productModal: document.getElementById('productModal'),
            customerModal: document.getElementById('customerModal'),
            orderModal: document.getElementById('orderModal'),
            configModal: document.getElementById('configModal'),
            orderDetailModal: document.getElementById('orderDetailModal'),
            welcomeModal: document.getElementById('welcomeModal'),
            productForm: document.getElementById('productForm'),
            customerForm: document.getElementById('customerForm'),
            configForm: document.getElementById('configForm'),
            welcomeForm: document.getElementById('welcomeForm'),
            ordersTableBody: document.getElementById('ordersTableBody'),
            productsGrid: document.getElementById('productsGrid'),
            customersTableBody: document.getElementById('customersTableBody'),
            customerSelector: document.getElementById('customerSelector'),
            orderProductsGrid: document.getElementById('orderProductsGrid'),
            orderSelectedProducts: document.getElementById('orderSelectedProducts'),
            orderSummary: document.getElementById('orderSummary'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText')
        };

        // Datos iniciales
        let appData = {
            business: {
                name: "Snack Orders",
                logo: "",
                whatsapp: "+52 123 456 7890",
                address: "",
                rfc: ""
            },
            products: [],
            customers: [],
            orders: [],
            settings: {
                ivaRate: 0.16,
                currency: "MXN",
                colorTheme: "default",
                colors: {
                    primary: "#FF6B35",
                    secondary: "#004E89",
                    background: "#f5f7fa",
                    text: "#212529",
                    cardBackground: "white",
                    buttonText: "white"
                }
            }
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadAppData();
            setupEventListeners();
            renderAllData();
            checkFirstUse();
            applyColorTheme();
        });

        // Cargar datos desde localStorage
        function loadAppData() {
            const savedData = localStorage.getItem('snackOrdersData');
            if (savedData) {
                appData = JSON.parse(savedData);
                updateBusinessInfo();
            }
        }

        // Guardar datos
        function saveAppData() {
            localStorage.setItem('snackOrdersData', JSON.stringify(appData));
        }

        // Aplicar tema de colores
        function applyColorTheme() {
            const colors = appData.settings.colors;
            document.documentElement.style.setProperty('--primary', colors.primary);
            document.documentElement.style.setProperty('--secondary', colors.secondary);
            document.documentElement.style.setProperty('--background-color', colors.background);
            document.documentElement.style.setProperty('--text-color', colors.text);
            document.documentElement.style.setProperty('--card-background', colors.cardBackground);
            document.documentElement.style.setProperty('--button-text', colors.buttonText);
            const primaryDark = adjustColor(colors.primary, -20);
            document.documentElement.style.setProperty('--primary-dark', primaryDark);
            const primaryRGB = hexToRgb(colors.primary);
            document.documentElement.style.setProperty('--primary-rgb', `${primaryRGB.r}, ${primaryRGB.g}, ${primaryRGB.b}`);
        }

        // Verificar primer uso
        function checkFirstUse() {
            if (!localStorage.getItem('snackOrdersData')) {
                elements.welcomeModal.classList.add('active');
            } else {
                elements.welcomeModal.classList.remove('active');
            }
        }

        // Actualizar información del negocio
        function updateBusinessInfo() {
            document.getElementById('business-name').textContent = appData.business.name;
            document.getElementById('business-contact').textContent = `WhatsApp: ${appData.business.whatsapp}`;
            const logoElement = document.getElementById('logo');
            if (appData.business.logo) {
                logoElement.innerHTML = `<img src="${appData.business.logo}" alt="Logo" style="width:100%;height:100%;object-fit:contain;padding:5px;">`;
            } else {
                logoElement.textContent = appData.business.name.charAt(0);
            }
            const logoPreview = document.getElementById('logoPreview');
            if (appData.business.logo) {
                logoPreview.innerHTML = `<img src="${appData.business.logo}" alt="Logo">`;
            } else {
                logoPreview.innerHTML = `<span>${appData.business.name.charAt(0)}</span>`;
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Tabs
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Botones principales
            elements.newProductBtn.addEventListener('click', () => openProductModal());
            elements.newCustomerBtn.addEventListener('click', () => openCustomerModal());
            elements.newOrderBtn.addEventListener('click', () => openOrderModal());
            elements.configBtn.addEventListener('click', () => openConfigModal());
            elements.refreshReportsBtn.addEventListener('click', () => refreshReports());

            // Cerrar modales
            document.getElementById('closeProductModal').addEventListener('click', () => closeModal(elements.productModal));
            document.getElementById('closeCustomerModal').addEventListener('click', () => closeModal(elements.customerModal));
            document.getElementById('closeOrderModal').addEventListener('click', () => closeModal(elements.orderModal));
            document.getElementById('closeConfigModal').addEventListener('click', () => closeModal(elements.configModal));
            document.getElementById('closeOrderDetailModal').addEventListener('click', () => closeModal(elements.orderDetailModal));

            // Formularios
            elements.productForm.addEventListener('submit', saveProduct);
            elements.customerForm.addEventListener('submit', saveCustomer);
            elements.configForm.addEventListener('submit', saveConfig);
            elements.welcomeForm.addEventListener('submit', saveWelcomeConfig);

            // Gestión de datos
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
                document.getElementById('importOptions').style.display = 'block';
            });
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
            document.getElementById('importFileInput').addEventListener('change', importData);
            document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);

            // Orden - Paso 1: Cliente
            document.getElementById('selectCustomerBtn').addEventListener('click', goToStep2);
            document.getElementById('newCustomerInOrderBtn').addEventListener('click', () => {
                closeModal(elements.orderModal);
                openCustomerModal();
            });

            // Orden - Paso 2: Productos
            document.getElementById('backToStep1Btn').addEventListener('click', goToStep1);
            document.getElementById('goToStep3Btn').addEventListener('click', goToStep3);

            // Orden - Paso 3: Confirmación
            document.getElementById('backToStep2Btn').addEventListener('click', goToStep2FromStep3);
            document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);

            // Controladores de color
            document.querySelectorAll('input[type="color"]').forEach(input => {
                input.addEventListener('input', function() {
                    const textId = this.id + 'Text';
                    document.getElementById(textId).value = this.value;
                });
            });

            document.querySelectorAll('input[type="text"][id$="Text"]').forEach(input => {
                input.addEventListener('input', function() {
                    const colorId = this.id.replace('Text', '');
                    document.getElementById(colorId).value = this.value;
                });
            });

            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });
        }

        // Cambiar pestaña
        function switchTab(tabId) {
            elements.tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            elements.tabContents.forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            if (tabId === 'orders') {
                renderOrders();
            } else if (tabId === 'products') {
                renderProducts();
            } else if (tabId === 'customers') {
                renderCustomers();
            } else if (tabId === 'reports') {
                document.getElementById('reportDetailContainer').style.display = 'none';
            }
        }

        // Renderizar todos los datos
        function renderAllData() {
            renderOrders();
            renderProducts();
            renderCustomers();
        }

        // ========== FUNCIONES DE PRODUCTOS ==========
        function generateId() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        // ========== FUNCIONES DE COLORES ==========
        function selectColorTheme(theme) {
            appData.settings.colorTheme = theme;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            const customControls = document.getElementById('customColorControls');
            if (theme === 'custom') {
                customControls.style.display = 'block';
                return;
            } else {
                customControls.style.display = 'none';
            }
            
            let colors;
            switch(theme) {
                case 'professional':
                    colors = {primary: "#2C3E50", secondary: "#34495E", background: "#ECF0F1", text: "#2C3E50", cardBackground: "white", buttonText: "white"};
                    break;
                case 'modern':
                    colors = {primary: "#3498DB", secondary: "#2980B9", background: "#F7F9FA", text: "#2C3E50", cardBackground: "white", buttonText: "white"};
                    break;
                case 'vibrant':
                    colors = {primary: "#9B59B6", secondary: "#8E44AD", background: "#F4ECF7", text: "#2C3E50", cardBackground: "white", buttonText: "white"};
                    break;
                case 'dark':
                    colors = {primary: "#34495E", secondary: "#2C3E50", background: "#1C2833", text: "#ECF0F1", cardBackground: "#2C3E50", buttonText: "white"};
                    break;
                default:
                    colors = {primary: "#FF6B35", secondary: "#004E89", background: "#f5f7fa", text: "#212529", cardBackground: "white", buttonText: "white"};
            }
            
            appData.settings.colors = colors;
            applyColorTheme();
            showNotification('Tema de colores aplicado correctamente');
        }

        function applyCustomColors() {
            const colors = {
                primary: document.getElementById('colorPrimary').value,
                secondary: document.getElementById('colorSecondary').value,
                background: document.getElementById('colorBackground').value,
                text: document.getElementById('colorText').value,
                cardBackground: "white",
                buttonText: "white"
            };
            appData.settings.colors = colors;
            appData.settings.colorTheme = 'custom';
            applyColorTheme();
            showNotification('Colores personalizados aplicados');
        }

        // ========== FUNCIONES DE IMPORTACIÓN MEJORADA ==========
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    importDataBuffer = JSON.parse(e.target.result);
                    if (importDataBuffer.business || importDataBuffer.products || importDataBuffer.customers || importDataBuffer.orders) {
                        showNotification('Archivo cargado. Selecciona qué datos importar.', 'success');
                    } else {
                        showNotification('El archivo no tiene un formato válido', 'error');
                        importDataBuffer = null;
                    }
                } catch (error) {
                    showNotification('Error al importar datos: ' + error.message, 'error');
                    importDataBuffer = null;
                }
            };
            reader.readAsText(file);
        }

        function confirmImport() {
            if (!importDataBuffer) {
                showNotification('No hay datos para importar', 'error');
                return;
            }
            
            let importCount = 0;
            const messages = [];
            
            // Importar productos
            if (document.getElementById('importProducts').checked && importDataBuffer.products) {
                importDataBuffer.products.forEach(newProduct => {
                    const exists = appData.products.some(p => p.id === newProduct.id || p.name === newProduct.name);
                    if (!exists) {
                        appData.products.push(newProduct);
                        importCount++;
                    }
                });
                messages.push(`${importDataBuffer.products.length} productos procesados`);
            }
            
            // Importar clientes
            if (document.getElementById('importCustomers').checked && importDataBuffer.customers) {
                importDataBuffer.customers.forEach(newCustomer => {
                    const exists = appData.customers.some(c => c.id === newCustomer.id || 
                        (c.phone && newCustomer.phone && c.phone === newCustomer.phone));
                    if (!exists) {
                        appData.customers.push(newCustomer);
                        importCount++;
                    }
                });
                messages.push(`${importDataBuffer.customers.length} clientes procesados`);
            }
            
            // Importar órdenes
            if (document.getElementById('importOrders').checked && importDataBuffer.orders) {
                importDataBuffer.orders.forEach(newOrder => {
                    const exists = appData.orders.some(o => o.id === newOrder.id);
                    if (!exists) {
                        appData.orders.push(newOrder);
                        importCount++;
                    }
                });
                messages.push(`${importDataBuffer.orders.length} órdenes procesadas`);
            }
            
            // Importar configuración
            if (document.getElementById('importBusiness').checked && importDataBuffer.business) {
                appData.business = {...appData.business, ...importDataBuffer.business};
                messages.push('Configuración del negocio actualizada');
            }
            
            saveAppData();
            renderAllData();
            updateBusinessInfo();
            
            if (importCount > 0) {
                showNotification(`${importCount} nuevos elementos importados. ${messages.join(', ')}`);
            } else {
                showNotification('No se importaron elementos nuevos (posibles duplicados)', 'info');
            }
            
            importDataBuffer = null;
            document.getElementById('importOptions').style.display = 'none';
            document.getElementById('importFileInput').value = '';
        }

        // ========== FUNCIONES DE REPORTES ==========
        function refreshReports() {
            if (currentReport) {
                generateReport(currentReport);
            }
            showNotification('Reportes actualizados');
        }

        function generateReport(type) {
            currentReport = type;
            const container = document.getElementById('reportDetailContainer');
            const detail = document.getElementById('reportDetail');
            
            let reportHTML = '';
            let reportTitle = '';
            
            switch(type) {
                case 'sales':
                    reportTitle = 'Reporte de Ventas por Período';
                    reportHTML = generateSalesReport();
                    break;
                case 'products':
                    reportTitle = 'Productos Más Vendidos';
                    reportHTML = generateProductsReport();
                    break;
                case 'customers':
                    reportTitle = 'Clientes Más Frecuentes';
                    reportHTML = generateCustomersReport();
                    break;
                case 'financial':
                    reportTitle = 'Estado Financiero';
                    reportHTML = generateFinancialReport();
                    break;
                case 'trends':
                    reportTitle = 'Tendencias de Ventas';
                    reportHTML = generateTrendsReport();
                    break;
            }
            
            detail.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>${reportTitle}</h3>
                    <div>
                        <button class="btn btn-sm btn-primary" onclick="exportReport('${type}')" title="Exportar a PDF">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="printReport()" title="Imprimir reporte">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
                ${reportHTML}
            `;
            
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function generateSalesReport() {
            const now = new Date();
            const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const recentOrders = appData.orders.filter(order => 
                new Date(order.date) >= last30Days && order.status !== 'cancelled'
            );
            
            let totalRevenue = 0;
            let orderCount = 0;
            recentOrders.forEach(order => {
                totalRevenue += calculateOrderTotal(order);
                orderCount++;
            });
            
            return `
                <div class="chart-container">
                    <h4>Resumen de Ventas (Últimos 30 días)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">${orderCount}</div>
                            <div>Órdenes Totales</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--success), #218838); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">$${totalRevenue.toFixed(2)}</div>
                            <div>Ingresos Totales</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--secondary), #003366); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">$${(totalRevenue / orderCount || 0).toFixed(2)}</div>
                            <div>Ticket Promedio</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Ventas por Día</h4>
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Órdenes</th>
                                    <th>Ingresos</th>
                                    <th>Ticket Promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateDailySalesHTML(recentOrders)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateDailySalesHTML(orders) {
            const dailySales = {};
            orders.forEach(order => {
                const date = new Date(order.date).toISOString().split('T')[0];
                const total = calculateOrderTotal(order);
                if (!dailySales[date]) dailySales[date] = { orders: 0, revenue: 0 };
                dailySales[date].orders++;
                dailySales[date].revenue += total;
            });
            
            let html = '';
            Object.keys(dailySales).sort().reverse().forEach(date => {
                const sales = dailySales[date];
                const avgTicket = sales.revenue / sales.orders;
                html += `<tr><td>${formatDate(date + 'T00:00:00')}</td><td>${sales.orders}</td><td>$${sales.revenue.toFixed(2)}</td><td>$${avgTicket.toFixed(2)}</td></tr>`;
            });
            return html;
        }

        function generateProductsReport() {
            const productSales = {};
            appData.orders.forEach(order => {
                if (order.status !== 'cancelled') {
                    order.items.forEach(item => {
                        const product = appData.products.find(p => p.id === item.productId);
                        if (product) {
                            if (!productSales[product.id]) {
                                productSales[product.id] = { name: product.name, quantity: 0, revenue: 0 };
                            }
                            productSales[product.id].quantity += item.quantity;
                            productSales[product.id].revenue += item.quantity * item.price;
                        }
                    });
                }
            });
            
            const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            const totalRevenue = topProducts.reduce((sum, product) => sum + product.revenue, 0);
            
            let html = `
                <div class="chart-container">
                    <h4>Top 10 Productos por Ventas</h4>
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%;">
                            <thead><tr><th>Producto</th><th>Cantidad Vendida</th><th>Ingresos Generados</th><th>Porcentaje</th></tr></thead>
                            <tbody>`;
            
            topProducts.forEach((product, index) => {
                const percentage = totalRevenue > 0 ? (product.revenue / totalRevenue * 100).toFixed(1) : 0;
                html += `
                    <tr>
                        <td>${index + 1}. ${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.revenue.toFixed(2)}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-dark));"></div>
                                </div>
                                <div>${percentage}%</div>
                            </div>
                        </td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <strong>Total de ingresos por productos:</strong> $${totalRevenue.toFixed(2)}
                    </div>
                </div>`;
            return html;
        }

        function generateCustomersReport() {
            const customerStats = {};
            appData.customers.forEach(customer => {
                const customerOrders = appData.orders.filter(order => order.customerId === customer.id && order.status !== 'cancelled');
                if (customerOrders.length > 0) {
                    let totalSpent = 0;
                    customerOrders.forEach(order => totalSpent += calculateOrderTotal(order));
                    customerStats[customer.id] = {
                        name: customer.name,
                        phone: customer.phone || 'No tiene',
                        orders: customerOrders.length,
                        totalSpent: totalSpent,
                        avgOrder: totalSpent / customerOrders.length
                    };
                }
            });
            
            const topCustomers = Object.values(customerStats).sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10);
            
            let html = `
                <div class="chart-container">
                    <h4>Top 10 Clientes por Valor</h4>
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%;">
                            <thead><tr><th>Cliente</th><th>Teléfono</th><th>Órdenes</th><th>Total Gastado</th><th>Promedio por Orden</th></tr></thead>
                            <tbody>`;
            
            topCustomers.forEach((customer, index) => {
                html += `<tr><td>${index + 1}. ${customer.name}</td><td>${customer.phone}</td><td>${customer.orders}</td><td>$${customer.totalSpent.toFixed(2)}</td><td>$${customer.avgOrder.toFixed(2)}</td></tr>`;
            });
            
            html += `</tbody></table></div>
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <strong>Clientes recurrentes:</strong> ${topCustomers.length} clientes han realizado más de una orden
                    </div>
                </div>`;
            return html;
        }

        function generateFinancialReport() {
            let totalRevenue = 0, completedOrders = 0, cancelledOrders = 0, pendingOrders = 0;
            appData.orders.forEach(order => {
                const orderTotal = calculateOrderTotal(order);
                if (order.status === 'completed') {
                    totalRevenue += orderTotal;
                    completedOrders++;
                } else if (order.status === 'cancelled') {
                    cancelledOrders++;
                } else if (order.status === 'process') {
                    pendingOrders++;
                }
            });
            
            const ivaAmount = totalRevenue * (appData.settings.ivaRate / (1 + appData.settings.ivaRate));
            const netRevenue = totalRevenue - ivaAmount;
            
            return `
                <div class="chart-container">
                    <h4>Estado Financiero General</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--success), #218838); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">$${totalRevenue.toFixed(2)}</div><div>Ingresos Totales</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #6c757d, #545b62); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">$${ivaAmount.toFixed(2)}</div><div>IVA Recaudado</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--info), #138496); color: white; border-radius: var(--border-radius);">
                            <div style="font-size: 24px; font-weight: bold;">$${netRevenue.toFixed(2)}</div><div>Ingreso Neto</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Estadísticas de Órdenes</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background-color: #d4edda; color: #155724; border-radius: var(--border-radius);">
                            <div style="font-size: 20px; font-weight: bold;">${completedOrders}</div><div>Completadas</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background-color: #fff3cd; color: #856404; border-radius: var(--border-radius);">
                            <div style="font-size: 20px; font-weight: bold;">${pendingOrders}</div><div>En Proceso</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background-color: #f8d7da; color: #721c24; border-radius: var(--border-radius);">
                            <div style="font-size: 20px; font-weight: bold;">${cancelledOrders}</div><div>Canceladas</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background-color: #d1ecf1; color: #0c5460; border-radius: var(--border-radius);">
                            <div style="font-size: 20px; font-weight: bold;">${appData.orders.length}</div><div>Total</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Análisis de Rentabilidad</h4>
                    <div style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <div style="margin-bottom: 10px;"><strong>Margen estimado:</strong> ${(netRevenue > 0 ? 'Positivo' : 'Negativo')}</div>
                        <div style="margin-bottom: 10px;"><strong>Órdenes por día promedio:</strong> ${(completedOrders / 30).toFixed(1)} (últimos 30 días)</div>
                        <div><strong>Proyección mensual:</strong> $${(totalRevenue * 30 / completedOrders || 0).toFixed(2)}</div>
                    </div>
                </div>`;
        }

        function generateTrendsReport() {
            const now = new Date();
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyData = {};
            last7Days.forEach(date => dailyData[date] = { orders: 0, revenue: 0, items: 0 });
            
            appData.orders.forEach(order => {
                if (order.status === 'completed') {
                    const orderDate = new Date(order.date).toISOString().split('T')[0];
                    if (dailyData[orderDate]) {
                        dailyData[orderDate].orders++;
                        dailyData[orderDate].revenue += calculateOrderTotal(order);
                        order.items.forEach(item => dailyData[orderDate].items += item.quantity);
                    }
                }
            });
            
            let html = `
                <div class="chart-container">
                    <h4>Tendencias de Ventas (Últimos 7 días)</h4>
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%;"><thead><tr><th>Fecha</th><th>Órdenes</th><th>Ingresos</th><th>Productos</th><th>Tendencia</th></tr></thead><tbody>`;
            
            last7Days.forEach(date => {
                const data = dailyData[date];
                const dateStr = new Date(date).toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric' });
                html += `<tr><td>${dateStr}</td><td>${data.orders}</td><td>$${data.revenue.toFixed(2)}</td><td>${data.items}</td>
                        <td><div style="display: flex; align-items: center; gap: 5px;">${data.orders > 0 ? '<i class="fas fa-arrow-up text-success"></i><span>Activo</span>' : '<i class="fas fa-minus text-secondary"></i><span>Sin ventas</span>'}</div></td></tr>`;
            });
            
            html += `</tbody></table></div>
                    <h4 style="margin-top: 30px;">Recomendaciones</h4>
                    <div style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <ul style="margin-bottom: 0;">
                            <li>Días con más ventas: ${getBestSellingDay(dailyData)}</li>
                            <li>Promedio diario: $${getDailyAverage(dailyData).toFixed(2)}</li>
                            <li>Productos por orden promedio: ${getItemsPerOrder(dailyData).toFixed(1)}</li>
                            <li>Recomendación: ${getRecommendation(dailyData)}</li>
                        </ul>
                    </div>
                </div>`;
            return html;
        }

        function getBestSellingDay(dailyData) {
            let bestDay = '', bestRevenue = 0;
            Object.keys(dailyData).forEach(date => {
                if (dailyData[date].revenue > bestRevenue) {
                    bestRevenue = dailyData[date].revenue;
                    bestDay = new Date(date).toLocaleDateString('es-MX', { weekday: 'long' });
                }
            });
            return bestDay || 'No hay datos suficientes';
        }

        function getDailyAverage(dailyData) {
            const revenues = Object.values(dailyData).map(d => d.revenue);
            return revenues.reduce((sum, rev) => sum + rev, 0) / revenues.length;
        }

        function getItemsPerOrder(dailyData) {
            let totalItems = 0, totalOrders = 0;
            Object.values(dailyData).forEach(data => {
                totalItems += data.items;
                totalOrders += data.orders;
            });
            return totalOrders > 0 ? totalItems / totalOrders : 0;
        }

        function getRecommendation(dailyData) {
            const revenues = Object.values(dailyData).map(d => d.revenue);
            const avgRevenue = revenues.reduce((sum, rev) => sum + rev, 0) / revenues.length;
            const minRevenue = Math.min(...revenues);
            const maxRevenue = Math.max(...revenues);
            
            if (maxRevenue - minRevenue > avgRevenue * 0.5) {
                return 'Considera promociones en días de baja venta';
            } else if (avgRevenue < 100) {
                return 'Podrías implementar combos para aumentar el ticket promedio';
            } else {
                return 'Las ventas son estables, considera expandir el horario o menú';
            }
        }

        function exportReport(type) {
            showNotification('Función de exportación de PDF en desarrollo', 'info');
        }

        function printReport() {
            window.print();
        }

        // ========== FUNCIONES UTILITARIAS ==========
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 255, g: 107, b: 53 };
        }

        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace("#", ""), 16);
            const r = Math.max(0, Math.min(255, ((num >> 16) + amount)));
            const g = Math.max(0, Math.min(255, ((num >> 8 & 0x00FF) + amount)));
            const b = Math.max(0, Math.min(255, ((num & 0x0000FF) + amount)));
            return "#" + (b | (g << 8) | (r << 16)).toString(16).padStart(6, '0');
        }

        // ========== FUNCIONES DE GESTIÓN DE DATOS ==========
        function renderOrders() {
            const ordersTableBody = elements.ordersTableBody;
            const emptyOrders = document.getElementById('emptyOrders');
            
            if (appData.orders.length === 0) {
                ordersTableBody.innerHTML = '';
                emptyOrders.style.display = 'block';
                return;
            }
            
            emptyOrders.style.display = 'none';
            const sortedOrders = [...appData.orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            let html = '';
            sortedOrders.forEach(order => {
                const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado' };
                const total = calculateOrderTotal(order);
                const statusClass = `status-${order.status}`;
                const statusText = order.status === 'process' ? 'En proceso' : order.status === 'completed' ? 'Completada' : 'Cancelada';
                html += `<tr><td>${order.id}</td><td>${customer.name}</td><td>${order.items.length} productos</td><td>$${total.toFixed(2)}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td><td>${formatDate(order.date)}</td>
                        <td class="actions"><button class="btn btn-sm btn-secondary" onclick="viewOrderDetail('${order.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')"><i class="fas fa-trash"></i></button>
                        ${order.status === 'process' ? `<button class="btn btn-sm btn-success" onclick="completeOrder('${order.id}')"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')"><i class="fas fa-times"></i></button>` : ''}</td></tr>`;
            });
            ordersTableBody.innerHTML = html;
        }

        function renderProducts() {
            const productsGrid = elements.productsGrid;
            const emptyProducts = document.getElementById('emptyProducts');
            
            if (appData.products.length === 0) {
                productsGrid.innerHTML = '';
                emptyProducts.style.display = 'block';
                return;
            }
            
            emptyProducts.style.display = 'none';
            let html = '';
            appData.products.forEach(product => {
                html += `<div class="product-card" data-id="${product.id}"><div class="product-img">${product.image ? 
                    `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 
                    `<i class="fas fa-hamburger"></i>`}</div><div class="product-info"><div class="product-name">${product.name}</div>
                    <div class="product-price">$${product.price.toFixed(2)}</div><div style="margin-top: 10px; display: flex; gap: 5px;">
                    <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')" style="flex:1;"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')" style="flex:1;"><i class="fas fa-trash"></i></button></div></div></div>`;
            });
            productsGrid.innerHTML = html;
        }

        function renderCustomers() {
            const customersTableBody = elements.customersTableBody;
            const emptyCustomers = document.getElementById('emptyCustomers');
            
            if (appData.customers.length === 0) {
                customersTableBody.innerHTML = '';
                emptyCustomers.style.display = 'block';
                return;
            }
            
            emptyCustomers.style.display = 'none';
            let html = '';
            appData.customers.forEach(customer => {
                const orderCount = appData.orders.filter(order => order.customerId === customer.id).length;
                html += `<tr><td>${customer.name}</td><td>${customer.phone || '-'}</td><td>${orderCount} órdenes</td>
                        <td class="actions"><button class="btn btn-sm btn-secondary" onclick="editCustomer('${customer.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            customersTableBody.innerHTML = html;
        }

        // ========== FUNCIONES DE MODALES ==========
        function openProductModal(productId = null) {
            editingProductId = productId;
            const modalTitle = document.getElementById('productModalTitle');
            const form = elements.productForm;
            
            if (productId) {
                modalTitle.textContent = 'Editar Producto';
                const product = appData.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productImage').value = product.image || '';
                }
            } else {
                modalTitle.textContent = 'Nuevo Producto';
                form.reset();
                document.getElementById('productId').value = '';
            }
            elements.productModal.classList.add('active');
        }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value || generateId();
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const image = document.getElementById('productImage').value;
            
            if (!name || isNaN(price)) {
                showNotification('Por favor, complete todos los campos requeridos', 'error');
                return;
            }
            
            const product = { id, name, price, image };
            if (editingProductId) {
                const index = appData.products.findIndex(p => p.id === editingProductId);
                if (index !== -1) appData.products[index] = product;
            } else {
                appData.products.push(product);
            }
            
            saveAppData();
            renderProducts();
            closeModal(elements.productModal);
            showNotification(`Producto ${editingProductId ? 'actualizado' : 'agregado'} correctamente`);
            if (elements.orderModal.classList.contains('active') && currentStep >= 2) {
                renderOrderProducts();
            }
        }

        function deleteProduct(productId) {
            if (confirm('¿Está seguro de eliminar este producto?')) {
                appData.products = appData.products.filter(p => p.id !== productId);
                saveAppData();
                renderProducts();
                showNotification('Producto eliminado correctamente');
            }
        }

        function openCustomerModal(customerId = null) {
            editingCustomerId = customerId;
            const modalTitle = document.getElementById('customerModalTitle');
            const form = elements.customerForm;
            
            if (customerId) {
                modalTitle.textContent = 'Editar Cliente';
                const customer = appData.customers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone || '';
                }
            } else {
                modalTitle.textContent = 'Nuevo Cliente';
                form.reset();
                document.getElementById('customerId').value = '';
            }
            elements.customerModal.classList.add('active');
        }

        function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('customerId').value || generateId();
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            
            if (!name) {
                showNotification('Por favor, complete el nombre del cliente', 'error');
                return;
            }
            
            const customer = { id, name, phone };
            if (editingCustomerId) {
                const index = appData.customers.findIndex(c => c.id === editingCustomerId);
                if (index !== -1) appData.customers[index] = customer;
            } else {
                appData.customers.push(customer);
            }
            
            saveAppData();
            renderCustomers();
            closeModal(elements.customerModal);
            showNotification(`Cliente ${editingCustomerId ? 'actualizado' : 'agregado'} correctamente`);
            if (elements.orderModal.classList.contains('active')) {
                renderCustomerSelector();
            }
        }

        function deleteCustomer(customerId) {
            const hasOrders = appData.orders.some(order => order.customerId === customerId);
            const message = hasOrders ? 'Este cliente tiene órdenes asociadas. ¿Está seguro de eliminar?' : '¿Está seguro de eliminar este cliente?';
            if (!confirm(message)) return;
            
            appData.customers = appData.customers.filter(c => c.id !== customerId);
            saveAppData();
            renderCustomers();
            showNotification('Cliente eliminado correctamente');
        }

        function openOrderModal() {
            resetOrderModal();
            elements.orderModal.classList.add('active');
            renderCustomerSelector();
        }

        function resetOrderModal() {
            currentStep = 1;
            selectedCustomer = null;
            selectedProducts = {};
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step3').classList.remove('completed');
            document.getElementById('orderStep1').style.display = 'block';
            document.getElementById('orderStep2').style.display = 'none';
            document.getElementById('orderStep3').style.display = 'none';
            document.getElementById('selectCustomerBtn').disabled = true;
            updateOrderSummary();
        }

        function renderCustomerSelector() {
            const customerSelector = elements.customerSelector;
            if (appData.customers.length === 0) {
                customerSelector.innerHTML = '<p>No hay clientes registrados. Crea uno nuevo.</p>';
                return;
            }
            
            let html = '';
            appData.customers.forEach(customer => {
                const isSelected = selectedCustomer && selectedCustomer.id === customer.id;
                html += `<div class="customer-card ${isSelected ? 'selected' : ''}" data-id="${customer.id}">
                        <div class="customer-name">${customer.name}</div><div class="customer-phone">${customer.phone || 'Sin teléfono'}</div></div>`;
            });
            customerSelector.innerHTML = html;
            document.querySelectorAll('.customer-card').forEach(card => {
                card.addEventListener('click', () => selectCustomer(card.getAttribute('data-id')));
            });
        }

        function selectCustomer(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (customer) {
                selectedCustomer = customer;
                document.querySelectorAll('.customer-card').forEach(card => {
                    if (card.getAttribute('data-id') === customerId) card.classList.add('selected');
                    else card.classList.remove('selected');
                });
                document.getElementById('selectCustomerBtn').disabled = false;
            }
        }

        function goToStep2() {
            if (!selectedCustomer) {
                showNotification('Por favor, seleccione un cliente', 'error');
                return;
            }
            currentStep = 2;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            document.getElementById('orderStep1').style.display = 'none';
            document.getElementById('orderStep2').style.display = 'block';
            renderOrderProducts();
        }

        function renderOrderProducts() {
            const orderProductsGrid = elements.orderProductsGrid;
            if (appData.products.length === 0) {
                orderProductsGrid.innerHTML = '<p>No hay productos disponibles. Agrega productos primero.</p>';
                return;
            }
            
            let html = '';
            appData.products.forEach(product => {
                const quantity = selectedProducts[product.id] ? selectedProducts[product.id].quantity : 0;
                const isSelected = quantity > 0;
                html += `<div class="product-card ${isSelected ? 'selected' : ''}" data-id="${product.id}"><div class="product-img">${product.image ? 
                    `<img src="${product.image}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">` : 
                    `<i class="fas fa-hamburger"></i>`}</div><div class="product-info"><div class="product-name">${product.name}</div>
                    <div class="product-price">$${product.price.toFixed(2)}</div><div class="quantity-control" style="margin-top: 10px;">
                    <button class="quantity-btn" onclick="decreaseProductQuantity('${product.id}')">-</button>
                    <input type="number" class="quantity-input" value="${quantity}" min="0" readonly>
                    <button class="quantity-btn" onclick="increaseProductQuantity('${product.id}')">+</button></div></div></div>`;
            });
            orderProductsGrid.innerHTML = html;
            updateSelectedProductsList();
            updateOrderSummary();
        }

        function increaseProductQuantity(productId) {
            if (!selectedProducts[productId]) selectedProducts[productId] = { productId, quantity: 0, price: 0 };
            selectedProducts[productId].quantity++;
            const product = appData.products.find(p => p.id === productId);
            if (product) selectedProducts[productId].price = product.price;
            updateProductCard(productId);
            updateSelectedProductsList();
            updateOrderSummary();
        }

        function decreaseProductQuantity(productId) {
            if (selectedProducts[productId] && selectedProducts[productId].quantity > 0) {
                selectedProducts[productId].quantity--;
                if (selectedProducts[productId].quantity === 0) delete selectedProducts[productId];
                updateProductCard(productId);
                updateSelectedProductsList();
                updateOrderSummary();
            }
        }

        function updateProductCard(productId) {
            const card = document.querySelector(`.product-card[data-id="${productId}"]`);
            if (card) {
                const quantity = selectedProducts[productId] ? selectedProducts[productId].quantity : 0;
                const input = card.querySelector('.quantity-input');
                if (input) input.value = quantity;
                if (quantity > 0) card.classList.add('selected');
                else card.classList.remove('selected');
            }
        }

        function updateSelectedProductsList() {
            const orderSelectedProducts = elements.orderSelectedProducts;
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            
            if (productsWithQuantity.length === 0) {
                orderSelectedProducts.innerHTML = '<p>No hay productos seleccionados. Agrega productos a la orden.</p>';
                return;
            }
            
            let html = '';
            productsWithQuantity.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId);
                if (product) {
                    const subtotal = item.quantity * product.price;
                    html += `<div class="product-order-item"><div class="product-order-info"><div><strong>${product.name}</strong></div>
                            <div>$${product.price.toFixed(2)} x ${item.quantity} = $${subtotal.toFixed(2)}</div></div>
                            <div><button class="btn btn-sm btn-danger" onclick="removeProductFromOrder('${item.productId}')"><i class="fas fa-trash"></i></button></div></div>`;
                }
            });
            orderSelectedProducts.innerHTML = html;
        }

        function removeProductFromOrder(productId) {
            delete selectedProducts[productId];
            updateProductCard(productId);
            updateSelectedProductsList();
            updateOrderSummary();
        }

        function updateOrderSummary() {
            let subtotal = 0;
            Object.values(selectedProducts).forEach(item => {
                const product = appData.products.find(p => p.id === item.productId);
                if (product) subtotal += item.quantity * product.price;
            });
            
            const iva = subtotal * appData.settings.ivaRate;
            const total = subtotal + iva;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            document.getElementById('confirmSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('confirmIva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('confirmTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('goToStep3Btn').disabled = subtotal === 0;
        }

        function goToStep3() {
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            if (productsWithQuantity.length === 0) {
                showNotification('Por favor, agregue al menos un producto a la orden', 'error');
                return;
            }
            
            currentStep = 3;
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            document.getElementById('orderStep2').style.display = 'none';
            document.getElementById('orderStep3').style.display = 'block';
            updateConfirmationInfo();
        }

        function updateConfirmationInfo() {
            document.getElementById('confirmCustomerName').textContent = selectedCustomer.name;
            document.getElementById('confirmCustomerPhone').textContent = selectedCustomer.phone || '-';
            const confirmProductsList = document.getElementById('confirmProductsList');
            let html = '';
            Object.values(selectedProducts).forEach(item => {
                if (item.quantity > 0) {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        const subtotal = item.quantity * product.price;
                        html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div>${product.name} (${item.quantity} x $${product.price.toFixed(2)})</div><div>$${subtotal.toFixed(2)}</div></div>`;
                    }
                }
            });
            confirmProductsList.innerHTML = html;
        }

        function goToStep1() {
            currentStep = 1;
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('orderStep1').style.display = 'block';
            document.getElementById('orderStep2').style.display = 'none';
        }

        function goToStep2FromStep3() {
            currentStep = 2;
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.remove('completed');
            document.getElementById('orderStep2').style.display = 'block';
            document.getElementById('orderStep3').style.display = 'none';
        }

        function saveOrder() {
            const productsWithQuantity = Object.values(selectedProducts).filter(item => item.quantity > 0);
            if (productsWithQuantity.length === 0) {
                showNotification('Por favor, agregue al menos un producto a la orden', 'error');
                return;
            }
            
            const orderId = generateId();
            const order = {
                id: orderId,
                customerId: selectedCustomer.id,
                items: productsWithQuantity.map(item => ({ productId: item.productId, quantity: item.quantity, price: item.price })),
                status: 'process',
                date: new Date().toISOString()
            };
            
            appData.orders.push(order);
            saveAppData();
            closeModal(elements.orderModal);
            showNotification(`Orden #${orderId} creada correctamente`);
            switchTab('orders');
            setTimeout(() => generateOrderPDF(orderId), 500);
        }

        function viewOrderDetail(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado', phone: '' };
            const total = calculateOrderTotal(order);
            document.getElementById('detailOrderId').textContent = orderId;
            
            let html = `<div class="order-detail-card"><h4>Cliente: ${customer.name}</h4>
                    <p>Teléfono: ${customer.phone || '-'}</p><p>Fecha: ${formatDate(order.date)}</p>
                    <p>Estado: <span class="status status-${order.status}">${order.status === 'process' ? 'En proceso' : order.status === 'completed' ? 'Completada' : 'Cancelada'}</span></p>
                    <h4 style="margin-top: 20px;">Productos:</h4>`;
            
            order.items.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId) || { name: 'Producto no encontrado', price: 0 };
                const itemTotal = item.quantity * item.price;
                html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div>${product.name} (${item.quantity} x $${item.price.toFixed(2)})</div><div>$${itemTotal.toFixed(2)}</div></div>`;
            });
            
            const subtotal = total / (1 + appData.settings.ivaRate);
            const iva = subtotal * appData.settings.ivaRate;
            html += `<div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;"><div>Subtotal:</div><div>$${subtotal.toFixed(2)}</div></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;"><div>IVA (${(appData.settings.ivaRate * 100)}%):</div><div>$${iva.toFixed(2)}</div></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-weight: bold; font-size: 18px; color: var(--primary);">
                    <div>Total:</div><div>$${total.toFixed(2)}</div></div></div></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateOrderPDF('${orderId}')"><i class="fas fa-file-pdf"></i> Generar PDF</button>
                    ${order.status === 'process' ? `<button class="btn btn-success" onclick="completeOrder('${orderId}')"><i class="fas fa-check"></i> Marcar como Completada</button>
                    <button class="btn btn-danger" onclick="cancelOrder('${orderId}')"><i class="fas fa-times"></i> Cancelar Orden</button>` : ''}</div>`;
            
            document.getElementById('orderDetailContent').innerHTML = html;
            elements.orderDetailModal.classList.add('active');
        }

        function completeOrder(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'completed';
                saveAppData();
                renderOrders();
                if (elements.orderDetailModal.classList.contains('active')) viewOrderDetail(orderId);
                showNotification(`Orden #${orderId} marcada como completada`);
            }
        }

        function cancelOrder(orderId) {
            if (confirm('¿Está seguro de cancelar esta orden?')) {
                const order = appData.orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    saveAppData();
                    renderOrders();
                    if (elements.orderDetailModal.classList.contains('active')) viewOrderDetail(orderId);
                    showNotification(`Orden #${orderId} cancelada`);
                }
            }
        }

        function deleteOrder(orderId) {
            if (confirm('¿Está seguro de eliminar esta orden?')) {
                appData.orders = appData.orders.filter(o => o.id !== orderId);
                saveAppData();
                renderOrders();
                showNotification('Orden eliminada correctamente');
            }
        }

        function generateOrderPDF(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const customer = appData.customers.find(c => c.id === order.customerId) || { name: 'Cliente no encontrado', phone: '' };
            const total = calculateOrderTotal(order);
            const subtotal = total / (1 + appData.settings.ivaRate);
            const iva = subtotal * appData.settings.ivaRate;
            
            const pdfContent = `<div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF6B35;">${appData.business.name}</div>
                    <div style="margin-top: 10px;">${appData.business.address || ''}</div>
                    <div>WhatsApp: ${appData.business.whatsapp}</div>${appData.business.rfc ? `<div>RFC: ${appData.business.rfc}</div>` : ''}
                </div>
                <div style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="margin: 0; color: #004E89;">COTIZACIÓN #${orderId}</h1>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div><div><strong>Fecha:</strong> ${formatDate(order.date)}</div>
                        <div><strong>Estado:</strong> ${order.status === 'process' ? 'En proceso' : order.status === 'completed' ? 'Completada' : 'Cancelada'}</div></div>
                        <div><div><strong>Cliente:</strong> ${customer.name}</div><div><strong>Teléfono:</strong> ${customer.phone || '-'}</div></div>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead><tr style="background-color: #f8f9fa;"><th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Producto</th>
                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Precio Unitario</th>
                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Cantidad</th>
                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Subtotal</th></tr></thead><tbody>`;
            
            let itemsHTML = '';
            order.items.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId) || { name: 'Producto no encontrado', price: 0 };
                const itemTotal = item.quantity * item.price;
                itemsHTML += `<tr><td style="padding: 12px; border-bottom: 1px solid #ddd;">${product.name}</td>
                <td style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">$${item.price.toFixed(2)}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">${item.quantity}</td>
                <td style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">$${itemTotal.toFixed(2)}</td></tr>`;
            });
            
            const pdfFooter = `</tbody></table><div style="margin-top: 30px; float: right; width: 300px;">
                <div style="display: flex; justify-content: space-between; padding: 10px 0;"><div>Subtotal:</div><div>$${subtotal.toFixed(2)}</div></div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0;"><div>IVA (${(appData.settings.ivaRate * 100)}%):</div><div>$${iva.toFixed(2)}</div></div>
                <div style="display: flex; justify-content: space-between; padding: 15px 0; font-weight: bold; font-size: 18px; border-top: 2px solid #333;">
                <div>TOTAL:</div><div>$${total.toFixed(2)}</div></div></div>
                <div style="clear: both; margin-top: 100px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
                <div>${appData.business.name} • ${appData.business.whatsapp} • ${appData.business.address || ''}</div><div>¡Gracias por su preferencia!</div></div></div>`;
            
            const fullPdfContent = pdfContent + itemsHTML + pdfFooter;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html><head><title>Cotización #${orderId}</title>
                <style>body { font-family: Arial, sans-serif; margin: 0; padding: 20px; } @media print { body { padding: 0; } }</style></head>
                <body>${fullPdfContent}<script>window.onload = function() { window.print(); };<\/script></body></html>`);
            printWindow.document.close();
            showNotification('PDF generado correctamente. Se abrirá en una nueva ventana para imprimir.');
        }

        function openConfigModal() {
            document.getElementById('configBusinessName').value = appData.business.name;
            document.getElementById('configLogo').value = appData.business.logo || '';
            document.getElementById('configWhatsApp').value = appData.business.whatsapp;
            document.getElementById('configAddress').value = appData.business.address || '';
            document.getElementById('configRFC').value = appData.business.rfc || '';
            
            const logoPreview = document.getElementById('logoPreview');
            if (appData.business.logo) {
                logoPreview.innerHTML = `<img src="${appData.business.logo}" alt="Logo">`;
            } else {
                logoPreview.innerHTML = `<span>${appData.business.name.charAt(0)}</span>`;
            }
            
            initializeColorControls();
            elements.configModal.classList.add('active');
        }

        function initializeColorControls() {
            const colors = appData.settings.colors;
            document.getElementById('colorPrimary').value = colors.primary;
            document.getElementById('colorPrimaryText').value = colors.primary;
            document.getElementById('colorSecondary').value = colors.secondary;
            document.getElementById('colorSecondaryText').value = colors.secondary;
            document.getElementById('colorBackground').value = colors.background;
            document.getElementById('colorBackgroundText').value = colors.background;
            document.getElementById('colorText').value = colors.text;
            document.getElementById('colorTextText').value = colors.text;
            document.getElementById('customColorPreview').style.backgroundColor = colors.primary;
            
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            const currentTheme = appData.settings.colorTheme;
            const themeOption = document.querySelector(`.color-option[onclick*="${currentTheme}"]`);
            if (themeOption) themeOption.classList.add('selected');
            if (currentTheme === 'custom') document.getElementById('customColorControls').style.display = 'block';
        }

        function saveConfig(e) {
            e.preventDefault();
            appData.business.name = document.getElementById('configBusinessName').value;
            appData.business.logo = document.getElementById('configLogo').value;
            appData.business.whatsapp = document.getElementById('configWhatsApp').value;
            appData.business.address = document.getElementById('configAddress').value;
            appData.business.rfc = document.getElementById('configRFC').value;
            saveAppData();
            updateBusinessInfo();
            closeModal(elements.configModal);
            showNotification('Configuración guardada correctamente');
        }

        function saveWelcomeConfig(e) {
            e.preventDefault();
            appData.business.name = document.getElementById('welcomeBusinessName').value;
            appData.business.whatsapp = document.getElementById('welcomeWhatsApp').value;
            saveAppData();
            updateBusinessInfo();
            closeModal(elements.welcomeModal);
            showNotification('¡Configuración completada! Ya puedes usar el sistema.');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `snack-orders-backup-${new Date().toISOString().split('T')[0]}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showNotification('Datos exportados correctamente');
        }

        function clearData() {
            if (confirm('¿Está seguro de borrar todos los datos? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('snackOrdersData');
                appData = {
                    business: { name: "Snack Orders", logo: "", whatsapp: "+52 123 456 7890", address: "", rfc: "" },
                    products: [], customers: [], orders: [],
                    settings: { ivaRate: 0.16, currency: "MXN", colorTheme: "default", colors: {
                        primary: "#FF6B35", secondary: "#004E89", background: "#f5f7fa", text: "#212529", cardBackground: "white", buttonText: "white"
                    }}
                };
                renderAllData();
                updateBusinessInfo();
                showNotification('Todos los datos han sido borrados');
            }
        }

        function closeModal(modal) {
            modal.classList.remove('active');
        }

        function showNotification(message, type = 'success') {
            elements.notificationText.textContent = message;
            elements.notification.className = 'notification';
            elements.notification.classList.add(type);
            elements.notification.classList.add('show');
            setTimeout(() => elements.notification.classList.remove('show'), 3000);
        }

        function calculateOrderTotal(order) {
            let subtotal = 0;
            order.items.forEach(item => subtotal += item.quantity * item.price);
            return subtotal + (subtotal * appData.settings.ivaRate);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Funciones globales
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.viewOrderDetail = viewOrderDetail;
        window.completeOrder = completeOrder;
        window.cancelOrder = cancelOrder;
        window.deleteOrder = deleteOrder;
        window.generateOrderPDF = generateOrderPDF;
        window.increaseProductQuantity = increaseProductQuantity;
        window.decreaseProductQuantity = decreaseProductQuantity;
        window.removeProductFromOrder = removeProductFromOrder;
        window.generateReport = generateReport;
        window.exportReport = exportReport;
        window.printReport = printReport;
        window.selectColorTheme = selectColorTheme;
        window.applyCustomColors = applyCustomColors;
    </script>
</body>
</html>
